<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Einsatzplanung</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
  * {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    -webkit-touch-callout: none;
  }

  html {
    -webkit-text-size-adjust: 100%;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  body {
    background-color: #f5f7fa;
    color: #2c3e50;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    padding: 8px;
    line-height: 1.3;
    overflow-x: hidden;
    min-width: 1024px;
  }

  .container {
    max-width: 95%;
    margin: 0 auto;
    overflow-x: hidden;
  }


  /* Desktop-Optimierung f√ºr verschiedene Monitore */
  @media (min-width: 2560px) {
    .container {
      max-width: 2400px;
    }
  }

  @media (min-width: 1920px) and (max-width: 2559px) {
    .container {
      max-width: 1850px;
    }
  }

  @media (min-width: 1680px) and (max-width: 1919px) {
    .container {
      max-width: 1600px;
    }
  }

  @media (min-width: 1440px) and (max-width: 1679px) {
    .container {
      max-width: 1380px;
    }
  }

  @media (min-width: 1366px) and (max-width: 1439px) {
    .container {
      max-width: 1300px;
    }
  }

  @media (min-width: 1280px) and (max-width: 1365px) {
    .container {
      max-width: 1220px;
    }
  }

  @media (min-width: 1024px) and (max-width: 1279px) {
    .container {
      max-width: 96%;
    }
  }

  .info-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    line-height: 1.4;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }
  
  .info-banner-icon {
    font-size: 20px;
    flex-shrink: 0;
  }
  
  .info-banner-text {
    flex: 1;
    font-weight: 500;
  }
  
  .info-banner a {
    color: white;
    text-decoration: underline;
    font-weight: 700;
    transition: opacity 0.2s;
    text-decoration-thickness: 2px;
  }
  
  .info-banner a:hover {
    opacity: 0.85;
    text-decoration: none;
  }

  h2 {
    font-size: 15px;
    font-weight: 600;
    color: #333;
    margin: 6px 0 4px 0;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 3px;
  }

  .einsatzplan-dashboard-container {
    display: flex;
    gap: 10px;
    align-items: stretch;
    margin-bottom: 6px;
    max-height: 340px;
  }

  .einsatzplan-wrapper {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .dashboard-wrapper {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .table-wrapper {
    flex: 1 1 auto;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    background: white;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  .einsatzplan-header {
    background: #4a90e2;
    color: white;
  }
  .einsatzplan-header th {
    padding: 10px 12px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.3px;
  }

  .pools-header {
    background: #4a90e2;
    color: white;
  }
  .pools-header th {
    padding: 8px 10px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.3px;
    text-align: center;
  }
  .pools-header th:first-child {
    text-align: left;
  }

  tbody tr {
    border-bottom: 1px solid #e9ecef;
    transition: all 0.2s ease;
  }
  tbody tr:hover {
    background-color: #f8f9fa;
  }

  tbody tr.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
  }
  tbody tr.drag-over {
    border-top: 3px solid #4a90e2;
  }

  td {
    padding: 8px 12px;
    vertical-align: middle;
    font-size: 13px;
  }

  .pools-table td {
    padding: 6px 8px;
    text-align: center;
    font-size: 11px;
  }
  .pools-table td:first-child {
    text-align: left;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .shift-group-row td {
    background: linear-gradient(135deg, #f0f4f8 0%, #e6edf5 100%);
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    font-size: 9px;
    color: #4a5f7a;
    padding: 4px 10px;
    border-radius: 6px;
    text-align: left;
    border-left: 3px solid #4a90e2;
  }

  .shift-label {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }

  .shift-label-top {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .shift-time {
    font-size: 9px;
    color: #64748b;
    letter-spacing: 0.2px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 2px;
  }
  
  .shift-time::before {
    content: "üïê";
    font-size: 10px;
  }

  .shift-label .editable {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 3px 10px;
    border-radius: 6px;
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
    font-weight: 700;
    letter-spacing: 0.4px;
    text-transform: uppercase;
    min-width: 60px;
    font-size: 10px;
    border: none;
    box-shadow: 0 1px 4px rgba(74, 144, 226, 0.3);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .shift-label .editable:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(74, 144, 226, 0.4), 0 2px 6px rgba(0, 0, 0, 0.15);
    background: linear-gradient(135deg, #5a9ff2 0%, #4585cd 100%);
  }

  .shift-label .editable:focus {
    background: linear-gradient(135deg, #357abd 0%, #2968a3 100%);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3), 0 6px 16px rgba(74, 144, 226, 0.4);
    outline: none;
  }

  .einsatzplan-wrapper .table-wrapper {
    background: none;
    box-shadow: none;
    padding: 0;
  }

  #einsatzplanTable {
    border-collapse: separate;
    border-spacing: 0 2px;
    width: 100%;
    padding: 6px 10px 8px;
    background: linear-gradient(135deg, #f5f7fb 0%, #eef1f9 100%);
    border-radius: 12px;
  }

  #einsatzplanTable thead th {
    padding: 6px 10px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.4px;
    border: none;
    text-transform: uppercase;
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
  }

  #einsatzplanTable thead th:first-child {
    border-radius: 12px 0 0 12px;
  }

  #einsatzplanTable thead th:last-child {
    border-radius: 0 12px 12px 0;
  }

  #einsatzplanTable tbody tr {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
    border: 1px solid rgba(74, 144, 226, 0.08);
    box-shadow: 0 4px 12px rgba(16, 43, 83, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
    border-radius: 16px;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  #einsatzplanTable tbody tr:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 0 12px 28px rgba(74, 144, 226, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
    background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
    border-color: rgba(74, 144, 226, 0.2);
  }

  #einsatzplanTable tbody tr.shift-group-row {
    box-shadow: none;
    background: transparent;
    transform: none;
  }

  #einsatzplanTable tbody tr.shift-group-row td:first-child,
  #einsatzplanTable tbody tr.shift-group-row td:last-child {
    border-radius: 0;
  }

  #einsatzplanTable tbody tr td {
    border: none;
    padding: 5px 8px;
    background: transparent;
  }

  #einsatzplanTable tbody tr td:first-child {
    display: flex;
    flex-direction: row;
    gap: 8px;
    align-items: center;
    border-radius: 10px 0 0 10px;
  }

  #einsatzplanTable tbody tr td:last-child {
    border-radius: 0 12px 12px 0;
    text-align: center;
    width: 120px;
  }

  #einsatzplanTable td:last-child {
    text-align: center;
    width: 120px;
  }

  .drag-handle {
    color: #94a3b8;
    cursor: grab;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.1) 0%, rgba(100, 116, 139, 0.08) 100%);
    border: 1px solid rgba(148, 163, 184, 0.15);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .drag-handle:hover {
    color: #4a90e2;
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.15) 0%, rgba(53, 122, 189, 0.12) 100%);
    border-color: rgba(74, 144, 226, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(74, 144, 226, 0.15);
  }
  .drag-handle:active {
    cursor: grabbing;
    transform: scale(0.95) translateY(0);
    box-shadow: 0 2px 4px rgba(74, 144, 226, 0.2);
  }

  .pool-badge {
    background: #f39c12;
    color: white;
    padding: 5px 12px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 11px;
    min-width: 50px;
    text-align: center;
    display: inline-block;
  }

  .schicht-frueh {
    background: #4a90e2;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-spat {
    background: #17a2b8;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-taeti {
    background: #e67e22;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-nacht {
    background: #6c757d;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-rotation {
    background: #e67e22;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-extra {
    background: #28a745;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-impf {
    background: #17a2b8;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-htvo {
    background: #17a2b8;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-imp {
    background: #17a2b8;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-spat {
    background: #17a2b8;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-htna {
    background: #17a2b8;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .schicht-imps {
    background: #17a2b8;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 12px;
    min-width: 70px;
    text-align: center;
    display: inline-block;
    cursor: pointer;
  }

  .ma-input {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 4px 8px;
    font-size: 13px;
    font-weight: 700;
    text-align: center;
    width: 60px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    color: #1e293b;
    user-select: text;
    -webkit-user-select: text;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    -webkit-appearance: none;
    appearance: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  .ma-input:hover {
    border-color: #94a3b8;
    background: #ffffff;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }
  .ma-input:focus {
    outline: none;
    border-color: #4a90e2;
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15), 0 4px 12px rgba(74, 144, 226, 0.1);
    transform: scale(1.05);
  }

  .calc-button {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 10px;
    transition: all 0.2s ease;
    -webkit-appearance: none;
    appearance: none;
    touch-action: manipulation;
  }
  .calc-button:hover {
    background: linear-gradient(135deg, #357abd, #2968a3);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .calc-button:active {
    transform: scale(0.98);
  }

  .editable {
    cursor: pointer;
    outline: none;
    user-select: text;
    -webkit-user-select: text;
    transition: background-color 0.2s ease;
    -webkit-touch-callout: text;
  }
  .editable:focus {
    background-color: #e7f3ff !important;
    box-shadow: inset 0 0 0 2px #4a90e2;
  }

  .dashboard-grid {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 8px;
    width: 100%;
    height: 100%;
  }

  .db-box {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    color: #333;
    user-select: none;
    transition: all 0.2s ease;
    padding: 8px;
  }

  .db-box:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
  }

  .status-wrapper {
    display: flex;
    gap: 15px;
    width: 100%;
  }

  .status-text-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    padding: 8px;
    transition: all 0.2s ease;
  }

  .status-text-box:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
  }

  .status-icons-container {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    padding: 8px;
    transition: all 0.2s ease;
  }

  .status-icons-container:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
  }

  .status-icons-box {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
    justify-content: center;
  }

  .status-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    opacity: 0.3;
    transform: scale(0.9);
  }

  .status-icon.active {
    opacity: 1;
    transform: scale(1);
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }

  .status-icon.green {
    background: #28a745;
    color: white;
  }

  .status-icon.orange {
    background: #f39c12;
    color: white;
  }

  .status-icon.red {
    background: #dc3545;
    color: white;
  }

  .db-label {
    font-size: 9px;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.6px;
    margin-bottom: 4px;
    color: #4a90e2;
  }

  .db-value {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 0.4px;
    color: #357abd;
    line-height: 1;
  }

  @media (max-width: 1024px) {
    .einsatzplan-dashboard-container {
      flex-direction: column;
    }

    .dashboard-wrapper {
      width: 100%;
      margin-top: 0;
    }

    .dashboard-grid {
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    body {
      padding: 15px;
    }

    .container {
      max-width: 1400px;
    }

    h2 {
      font-size: 18px;
    }

    .einsatzplan-dashboard-container {
      min-height: auto;
    }

    .dashboard-grid {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto auto;
    }

    .status-wrapper {
      flex-direction: column;
      gap: 10px;
    }

    .db-value {
      font-size: 28px;
    }
  }

  @supports (-webkit-touch-callout: none) {
    input[type="number"] {
      font-size: 16px;
    }
  }

  .nav-bar {
    background: white;
    border-radius: 6px;
    padding: 6px 12px;
    margin-bottom: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .nav-links {
    display: flex;
    gap: 10px;
  }

  .nav-link {
    background: #f5f7fa;
    color: #4a90e2;
    border: 1px solid #dee2e6;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }

  .nav-link:hover {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
  }

  .nav-link.active {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
  }

  .dev-mode-btn {
    background: #dc3545;
    color: white;
    border: 1px solid #dc3545;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .dev-mode-btn:hover {
    background: #c82333;
    border-color: #c82333;
  }

  .dev-mode-btn.active {
    background: #28a745;
    border-color: #28a745;
  }

  .dev-mode-btn.active:hover {
    background: #218838;
    border-color: #218838;
  }

  .settings-bar {
    background: white;
    border-radius: 6px;
    padding: 4px 12px;
    margin-bottom: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
  }

  .settings-label {
    font-size: 12px;
    color: #666;
    font-weight: 500;
  }

  .dark-mode-toggle {
    background: rgba(74, 144, 226, 0.1);
    color: #4a90e2;
    border: 1px solid rgba(74, 144, 226, 0.3);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .dark-mode-toggle:hover {
    background: rgba(74, 144, 226, 0.2);
    border-color: rgba(74, 144, 226, 0.5);
  }

  .dev-mode-toggle {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .dev-mode-toggle:hover {
    background: rgba(220, 53, 69, 0.2);
    border-color: rgba(220, 53, 69, 0.5);
  }

  .dev-mode-toggle.active {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
  }

  .dev-controls {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background: rgba(220, 53, 69, 0.05);
    border: 1px solid rgba(220, 53, 69, 0.2);
    border-radius: 6px;
    font-size: 12px;
  }

  body.dev-mode .dev-controls {
    display: block;
  }

  body.dark-mode {
    background-color: #1a1a2e;
    color: #e0e0e0;
  }

  body.dark-mode .alert {
    background-color: #3a3a00;
    border-color: #6a6a00;
    color: #ffd700;
  }

  body.dark-mode h2 {
    color: #e0e0e0;
    border-bottom-color: #444;
  }

  body.dark-mode .table-wrapper {
    background: #2d2d44;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  body.dark-mode table {
    background: #2d2d44;
  }

  body.dark-mode tbody tr {
    border-bottom-color: #444;
  }

  body.dark-mode tbody tr:hover {
    background-color: #3a3a54;
  }

  body.dark-mode td {
    color: #e0e0e0;
  }

  body.dark-mode .ma-input {
    background: #3a3a54;
    color: #e0e0e0;
    border-color: #555;
  }

  body.dark-mode .db-box,
  body.dark-mode .status-text-box,
  body.dark-mode .status-icons-container {
    background: #2d2d44;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }

  body.dark-mode .db-label {
    color: #6ca6e8;
  }

  body.dark-mode .db-value {
    color: #8ab4f8;
  }

  body.dark-mode .settings-bar {
    background: #2d2d44;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  body.dark-mode .settings-label {
    color: #a0a0a0;
  }

  body.dark-mode .nav-bar {
    background: #2d2d44;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  body.dark-mode .pool-controls {
    background: #2d2d44 !important;
  }

  body.dark-mode .pool-controls label {
    color: #a0a0a0 !important;
  }

  body.dark-mode .pool-controls input {
    background: #3a3a54 !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
  }

  body.dark-mode #poolTable input,
  body.dark-mode #poolTable select {
    background: #3a3a54;
    color: #e0e0e0;
    border-color: #555;
  }

  body.dark-mode #poolTable input[readonly] {
    background: #2d2d44 !important;
    color: #888 !important;
  }

  body.dark-mode .nav-link {
    background: #3a3a54;
    color: #8ab4f8;
    border-color: #555;
  }

  body.dark-mode .nav-link:hover {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
  }

  body.dark-mode .nav-link.active {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
  }

  body.dark-mode .dark-mode-toggle {
    background: rgba(138, 180, 248, 0.1);
    color: #8ab4f8;
    border-color: rgba(138, 180, 248, 0.3);
  }

  body.dark-mode .dark-mode-toggle:hover {
    background: rgba(138, 180, 248, 0.2);
    border-color: rgba(138, 180, 248, 0.5);
  }

  body.dark-mode .timeline-container {
    background: #2d2d44;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  body.dark-mode .timeline-header {
    background: #357abd;
    border-bottom-color: #2968a3;
  }

  body.dark-mode .timeline-slot {
    border-right-color: rgba(255,255,255,0.1);
  }

  body.dark-mode .timeline-slot:hover {
    background: rgba(255,255,255,0.05);
  }

  body.dark-mode .timeline-canvas {
    background: #3a3a54;
    border-color: #6ca6e8;
  }

  body.dark-mode .date-navigation {
    background: #2d2d44;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  body.dark-mode .date-display {
    color: #e0e0e0;
  }

  /* Final Overrides: einsatzplan-dashboard-container (Gr√∂√üe/Abst√§nde) */
  .einsatzplan-dashboard-container {
    width: 100%;
    gap: clamp(12px, 2vw, 24px);
    align-items: stretch; /* beide Spalten gleiche H√∂he */
    min-height: clamp(320px, 40vh, 620px);
  }

  .einsatzplan-dashboard-container > .einsatzplan-wrapper { flex: 1 1 50%; }
  .einsatzplan-dashboard-container > .dashboard-wrapper { flex: 1 1 50%; margin-top: 0; }

  @media (max-width: 1280px) {
    .einsatzplan-dashboard-container > .einsatzplan-wrapper { flex-basis: 50%; }
    .einsatzplan-dashboard-container > .dashboard-wrapper { flex-basis: 50%; }
  }

  @media (max-width: 1024px) {
    .einsatzplan-dashboard-container { flex-direction: column; min-height: auto; }
    .einsatzplan-dashboard-container > * { width: 100%; }
  }

  @media (max-width: 768px) {
    .einsatzplan-dashboard-container { gap: 12px; }
  }

  /* Final Overrides: einsatzplanTable (Gr√∂√üe/Scroll/Spalten) */
  .einsatzplan-wrapper .table-wrapper {
    overflow: auto;                 /* erm√∂glicht Scrollen innerhalb des Bereichs */
    max-height: clamp(380px, 48vh, 680px); /* steuert die Gesamth√∂he des Tabellenbereichs */
  }

  /* Sticky Header f√ºr bessere Orientierung beim Scrollen */
  #einsatzplanTable thead th {
    position: sticky;
    top: 0;
    z-index: 10;
  }

  /* Flexible Breite der MA-Spalte; erste Spalte bekommt den Rest */
  #einsatzplanTable tbody tr td:last-child,
  #einsatzplanTable td:last-child {
    width: clamp(100px, 8vw, 160px);
  }

  /* Leicht kompakter auf mittleren Bildschirmen */
  @media (max-width: 1366px) {
    #einsatzplanTable { border-spacing: 0 10px; }
    #einsatzplanTable tbody tr td { padding: 12px 14px; }
  }

  /* Noch kompakter auf kleineren Bildschirmen */
  @media (max-width: 1280px) {
    #einsatzplanTable { border-spacing: 0 8px; }
    #einsatzplanTable tbody tr td { padding: 10px 12px; }
    #einsatzplanTable tbody tr td:last-child,
    #einsatzplanTable td:last-child { width: clamp(92px, 9vw, 140px); }
  }

  /* Verbesserungen: einsatzplan-dashboard-container (Gr√∂√üe/Abst√§nde) */
  .einsatzplan-dashboard-container {
    width: 100%;
    gap: clamp(12px, 2vw, 24px);
    align-items: stretch; /* beide Spalten gleiche H√∂he */
    min-height: clamp(320px, 40vh, 620px);
  }

  /* Zielgerichtete Breitensteuerung nur innerhalb des Containers */
  .einsatzplan-dashboard-container > .einsatzplan-wrapper {
    flex: 1 1 50%;
  }
  .einsatzplan-dashboard-container > .dashboard-wrapper {
    flex: 1 1 50%;
    margin-top: 0; /* √ºbersteuert das fr√ºhere margin-top f√ºr bessere Ausrichtung */
  }

  /* Anpassungen f√ºr mittlere Viewports */
  @media (max-width: 1280px) {
    .einsatzplan-dashboard-container > .einsatzplan-wrapper { flex-basis: 58%; }
    .einsatzplan-dashboard-container > .dashboard-wrapper { flex-basis: 42%; }
  }

  /* Spalten-Layout auf kleineren Bildschirmen beibehalten und Abst√§nde optimieren */
  @media (max-width: 1024px) {
    .einsatzplan-dashboard-container {
      flex-direction: column;
      min-height: auto;
    }
    .einsatzplan-dashboard-container > * {
      width: 100%;
    }
  }

  @media (max-width: 768px) {
    .einsatzplan-dashboard-container {
      gap: 12px;
    }
  }

  body.dark-mode .date-nav-btn {
    background: #357abd;
  }

  body.dark-mode .date-nav-btn:hover {
    background: #4a90e2;
  }

  body.dark-mode .heute-btn {
    background: #1e7e34;
  }

  body.dark-mode .heute-btn:hover {
    background: #28a745;
  }

  body.dark-mode .drag-section {
    background: linear-gradient(to bottom, #2d2d44, #3a3a54);
    border-color: #444;
  }

  body.dark-mode .drag-section h3 {
    color: #8ab4f8;
    border-bottom-color: #6ca6e8;
  }

  body.dark-mode .shift-group-row td {
    background: #2f3443;
    color: #c5cfe5;
  }

  body.dark-mode .shift-time {
    color: #9aa6c1;
  }

  body.dark-mode .shift-label .editable {
    background: linear-gradient(135deg, rgba(74,144,226,0.25) 0%, rgba(57,119,196,0.15) 100%);
    color: #e6eefc;
    border-color: rgba(74,144,226,0.4);
  }

  body.dark-mode .shift-label .editable:hover {
    box-shadow: 0 4px 10px rgba(74, 144, 226, 0.25);
  }

  .pool-view-switch {
    display: flex;
    gap: 4px;
    border: 1px solid #dee2e6;
    border-radius: 999px;
    padding: 4px;
    background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  .pool-view-btn {
    background: transparent;
    border: none;
    padding: 8px 24px;
    font-size: 13px;
    font-weight: 600;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 999px;
    white-space: nowrap;
  }

  .pool-view-btn.active {
    background: #4a90e2;
    color: white;
  }

  .pool-view-btn:not(.active):hover {
    background: #f1f3f5;
  }

  .pool-view-hidden {
    display: none !important;
  }

  .date-navigation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 8px 0 8px 0;
    padding: 8px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .date-nav-btn {
    background: #4a90e2;
    color: white;
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.2s ease;
    -webkit-appearance: none;
    appearance: none;
    touch-action: manipulation;
  }

  .date-nav-btn:hover {
    background: #357abd;
  }

  .date-nav-btn:active {
    background: #2968a3;
    transform: scale(0.95);
  }

  .date-display {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    min-width: 250px;
    text-align: center;
  }

  .heute-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .heute-btn:hover {
    background: #218838;
  }

  .timeline-container {
    background: white;
    border-radius: 8px;
    overflow-x: hidden;
    overflow-y: visible;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 10px;
    max-width: 100%;
  }

  .timeline-header {
    display: flex;
    background: #4a90e2;
    color: white;
    border-bottom: 2px solid #357abd;
    position: sticky;
    top: 0;
    z-index: 50;
    flex-wrap: nowrap;
  }

  .timeline-slot {
    flex: 1;
    min-width: 50px;
    padding: 8px 4px;
    text-align: center;
    font-weight: 600;
    font-size: 10px;
    border-right: 1px solid rgba(255,255,255,0.2);
    letter-spacing: 0.2px;
    text-transform: uppercase;
  }

  .timeline-slot:hover {
    background: rgba(255,255,255,0.1);
  }

  .timeline-slot:last-child {
    border-right: none;
  }

  .timeline-canvas {
    position: relative;
    min-height: 270px;
    max-height: 270px;
    background: #fafafa;
    padding: 5px;
    overflow: hidden;
    border: 3px solid #4a90e2;
    border-top: none;
    box-sizing: border-box;
  }

  .timeline-box {
    position: absolute;
    background: white;
    border: 2px solid #333;
    border-radius: 3px;
    padding: 3px 4px;
    cursor: grab;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 9px;
    font-weight: 600;
    color: white;
    user-select: none;
    transition: box-shadow 0.2s ease, opacity 0.1s ease;
    z-index: 10;
    min-width: 45px;
    height: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    will-change: transform;
  }

  .timeline-box:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 20;
  }

  .timeline-box.dragging {
    opacity: 0.85;
    cursor: grabbing !important;
    z-index: 100;
    transition: none;
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  }

  .timeline-box-text {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .timeline-box-time {
    font-size: 9px;
    font-weight: 500;
    opacity: 0.85;
    background: rgba(0,0,0,0.15);
    padding: 1px 6px;
    border-radius: 8px;
    white-space: nowrap;
  }

  .timeline-box .resize-handle {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 12px;
    cursor: ew-resize;
    background: rgba(0,0,0,0.15);
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 0 3px 3px 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .timeline-box .resize-handle::after {
    content: '‚ãÆ';
    color: white;
    font-size: 12px;
    font-weight: bold;
  }

  .timeline-box:hover .resize-handle {
    opacity: 1;
  }

  .timeline-box .resize-handle:hover {
    background: rgba(0,0,0,0.25);
  }

  .timeline-box .delete-btn {
    position: absolute;
    top: 3px;
    right: 3px;
    background: rgba(220, 53, 69, 0.95);
    color: white;
    border: none;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 12px;
    line-height: 1;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s ease;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }

  .timeline-box:hover .delete-btn {
    opacity: 1;
  }

  .timeline-box .delete-btn:hover {
    background: #dc3545;
    transform: scale(1.1);
  }

  .timeline-box.schicht-frueh {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    border-color: #2968a3;
  }

  .timeline-box.schicht-spat {
    background: linear-gradient(135deg, #17a2b8, #138496);
    border-color: #0d6674;
  }

  .timeline-box.schicht-taeti {
    background: linear-gradient(135deg, #e67e22, #d35400);
    border-color: #a04000;
  }

  .timeline-box.schicht-nacht {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    border-color: #343a40;
  }

  .timeline-box.schicht-extra {
    background: linear-gradient(135deg, #28a745, #218838);
    border-color: #1e7e34;
  }

  .timeline-box.pool-box {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    border-color: #c87f0a;
  }

  .drag-items-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .drag-section {
    flex: 1;
    background: linear-gradient(to bottom, #ffffff, #f8f9fa);
    border-radius: 6px;
    padding: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
  }

  .drag-section h3 {
    margin: 0 0 6px 0;
    font-size: 11px;
    font-weight: 600;
    color: #357abd;
    border-bottom: 2px solid #4a90e2;
    padding-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .drag-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 6px;
  }

  .drag-item {
    padding: 6px 8px;
    border-radius: 4px;
    text-align: center;
    font-weight: 600;
    font-size: 11px;
    cursor: grab;
    transition: all 0.15s ease;
    user-select: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    border: 1px solid rgba(0,0,0,0.1);
  }

  .drag-item:active {
    cursor: grabbing;
    transform: scale(0.96);
  }

  .drag-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.18);
  }

  .drag-item.schicht-item {
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  .drag-item.pool-item {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  @media (max-width: 768px) {
    body {
      padding: 10px;
    }

    h2 {
      font-size: 16px;
      margin: 20px 0 10px 0;
    }

    .alert {
      padding: 8px 12px;
      font-size: 12px;
      margin-bottom: 15px;
    }

    .einsatzplan-dashboard-container {
      gap: 15px;
      margin-bottom: 15px;
    }

    .einsatzplan-header th {
      padding: 10px 8px;
      font-size: 11px;
    }

    .pools-header th {
      padding: 8px 6px;
      font-size: 10px;
    }

    td {
      padding: 8px 10px;
      font-size: 12px;
    }

    .pools-table td {
      padding: 6px 8px;
      font-size: 11px;
    }

    .ma-input {
      width: 60px;
      padding: 6px 8px;
      font-size: 14px;
    }

    .db-label {
      font-size: 9px;
    }

    .db-value {
      font-size: 24px;
    }

    .date-navigation {
      padding: 8px;
      gap: 10px;
      margin: 15px 0 10px 0;
    }

    .date-nav-btn {
      width: 36px;
      height: 36px;
      font-size: 14px;
    }

    .date-display {
      font-size: 12px;
      min-width: 180px;
    }

    .heute-btn {
      padding: 6px 12px;
      font-size: 12px;
    }

    .drag-section {
      padding: 10px;
    }

    .drag-section h3 {
      font-size: 11px;
      margin-bottom: 8px;
    }

    .drag-items-grid {
      gap: 6px;
    }

    .drag-item {
      padding: 5px 8px;
      font-size: 9px;
    }

    .settings-bar {
      padding: 8px 12px;
      margin-bottom: 15px;
    }

    .settings-label {
      font-size: 11px;
    }

    .dark-mode-toggle {
      padding: 5px 10px;
      font-size: 12px;
    }
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    animation: fadeIn 0.2s ease forwards;
    padding: 20px;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  @keyframes slideDown {
    from {
      transform: translateY(-30px) scale(0.95);
      opacity: 0;
    }
    to {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  .modal-box {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow: hidden;
    animation: slideDown 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .modal-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }

  .modal-icon.info {
    background: #e3f2fd;
    color: #1976d2;
  }

  .modal-icon.success {
    background: #e8f5e9;
    color: #388e3c;
  }

  .modal-icon.error {
    background: #ffebee;
    color: #d32f2f;
  }

  .modal-icon.question {
    background: #fff3e0;
    color: #f57c00;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    flex: 1;
  }

  .modal-content {
    padding: 20px 24px;
    color: #495057;
    font-size: 14px;
    line-height: 1.6;
    overflow-y: auto;
    white-space: pre-wrap;
  }

  .modal-input {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    font-size: 14px;
    margin-top: 12px;
    font-family: inherit;
    transition: border-color 0.2s ease;
  }

  .modal-input:focus {
    outline: none;
    border-color: #4a90e2;
  }

  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .modal-btn {
    padding: 10px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 80px;
  }

  .modal-btn-primary {
    background: #4a90e2;
    color: white;
  }

  .modal-btn-primary:hover {
    background: #357abd;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
  }

  .modal-btn-success {
    background: #28a745;
    color: white;
  }

  .modal-btn-success:hover {
    background: #218838;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }

  .modal-btn-danger {
    background: #dc3545;
    color: white;
  }

  .modal-btn-danger:hover {
    background: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
  }

  .modal-btn-secondary {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
  }

  .modal-btn-secondary:hover {
    background: #e9ecef;
  }

  .modal-btn:active {
    transform: scale(0.98);
  }

  body.dark-mode .modal-box {
    background: #2d2d44;
  }

  body.dark-mode .modal-header,
  body.dark-mode .modal-footer {
    border-color: #555;
  }

  body.dark-mode .modal-title {
    color: #e0e0e0;
  }

  body.dark-mode .modal-content {
    color: #bbb;
  }

  body.dark-mode .modal-input {
    background: #3a3a54;
    border-color: #555;
    color: #e0e0e0;
  }

  body.dark-mode .modal-btn-secondary {
    background: #3a3a54;
    color: #e0e0e0;
    border-color: #555;
  }

  body.dark-mode .modal-btn-secondary:hover {
    background: #4a5a6a;
  }

  .date-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }

  .date-nav-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 6px 14px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #495057;
  }

  .date-nav-btn:hover {
    background: #e9ecef;
    border-color: #17a2b8;
    color: #17a2b8;
  }

  .date-nav-btn:active {
    transform: scale(0.95);
  }

  .date-display {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    min-width: 200px;
    text-align: center;
  }

  body.dark-mode .date-selector {
    background: #2d2d44;
  }

  body.dark-mode .date-nav-btn {
    background: #3a3a54;
    border-color: #555;
    color: #e0e0e0;
  }

  body.dark-mode .date-nav-btn:hover {
    background: #4a5a6a;
    border-color: #17a2b8;
  }

  body.dark-mode .date-display {
    color: #e0e0e0;
  }

  /* Final Overrides: einsatzplan-dashboard-container (Gr√∂√üe/Abst√§nde) */
  .einsatzplan-dashboard-container {
    width: 100%;
    gap: clamp(12px, 2vw, 24px);
    align-items: stretch;
    min-height: clamp(320px, 40vh, 620px);
  }

  .einsatzplan-dashboard-container > .einsatzplan-wrapper { flex: 1 1 50%; }
  .einsatzplan-dashboard-container > .dashboard-wrapper { flex: 1 1 50%; margin-top: 0; }

  @media (max-width: 1280px) {
    .einsatzplan-dashboard-container > .einsatzplan-wrapper { flex-basis: 50%; }
    .einsatzplan-dashboard-container > .dashboard-wrapper { flex-basis: 50%; }
  }

  @media (max-width: 1024px) {
    .einsatzplan-dashboard-container { flex-direction: column; min-height: auto; }
    .einsatzplan-dashboard-container > * { width: 100%; }
  }

  @media (max-width: 768px) {
    .einsatzplan-dashboard-container { gap: 12px; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="nav-bar" style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; gap: 10px; align-items: center;">
        <span class="settings-label">Einstellungen:</span>
        <button class="nav-link" id="darkModeBtn" onclick="toggleDarkMode()" style="cursor: pointer; border: none;">
          <span id="darkModeText">Dunkelmodus</span>
        </button>
        <button class="nav-link" id="devModeBtn" onclick="toggleDevMode()" style="cursor: pointer; border: none; background: #dc3545; color: white;">
          <span id="devModeText">Developer-Modus</span>
        </button>
      </div>

      <div class="nav-links">
        <a href="index.html" class="nav-link" style="background: #4a90e2; color: white;">Einsatzplanung</a>
        <a href="seite3.html" class="nav-link dev-only" id="navSeite3" style="display: none;">Mitarbeiter</a>
        <a href="produkte-import.html" class="nav-link dev-only" id="navProdukte" style="display: none;">Produkte Import</a>
        <a href="test-import.html" class="nav-link dev-only" id="navTest" style="display: none;">Test & Diagnose</a>
      </div>
    </div>

    <div class="dev-controls">
      <strong>Developer-Modus aktiv:</strong> Sie k√∂nnen jetzt weitere Funktionen nutzen und direkt bearbeiten.
    </div>

    <div class="einsatzplan-dashboard-container">
      <div class="einsatzplan-wrapper">
        <h2>Einsatzplan</h2>
        <div class="table-wrapper">
          <table id="einsatzplanTable">
            <thead class="einsatzplan-header">
              <tr>
                <th>SCHICHT (EDITIERBAR)</th>
                <th style="text-align: center;">MA</th>
              </tr>
            </thead>
            <tbody>
              <tr draggable="true">
                <td>
                  <div class="shift-label">
                    <div class="shift-label-top">
                      <span class="drag-handle">‚ãÆ‚ãÆ</span>
                      <span id="fruehName" class="schicht-frueh editable" contenteditable="true">FR√úH</span>
                    </div>
                    <span class="shift-time">06:00 - 15:30</span>
                  </div>
                </td>
                <td style="text-align: center;">
                  <input type="number" class="ma-input" id="maFrueh" value="0" min="0" readonly
                         style="background: #e8f4f8; color: #4a90e2; font-weight: 600; cursor: not-allowed;">
                </td>
              </tr>
              <tr draggable="true">
                <td>
                  <div class="shift-label">
                    <div class="shift-label-top">
                      <span class="drag-handle">‚ãÆ‚ãÆ</span>
                      <span id="spatName" class="schicht-spat editable" contenteditable="true">SP√ÑT</span>
                    </div>
                    <span class="shift-time">15:30 - 19:00</span>
                  </div>
                </td>
                <td style="text-align: center;">
                  <input type="number" class="ma-input" id="maSpat" value="0" min="0" readonly
                         style="background: #e8f4f8; color: #4a90e2; font-weight: 600; cursor: not-allowed;">
                </td>
              </tr>
              <tr draggable="true">
                <td>
                  <div class="shift-label">
                    <div class="shift-label-top">
                      <span class="drag-handle">‚ãÆ‚ãÆ</span>
                      <span id="rotationName" class="schicht-rotation editable" contenteditable="true">ROTATION</span>
                    </div>
                    <span class="shift-time">Flexibel</span>
                  </div>
                </td>
                <td style="text-align: center;">
                  <input type="number" class="ma-input" id="maRotation" value="0" min="0" readonly
                         style="background: #e8f4f8; color: #4a90e2; font-weight: 600; cursor: not-allowed;">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="dashboard-wrapper">
        <div class="dashboard-grid">
          <div class="status-wrapper">
            <div class="status-text-box">
              <div class="db-label">STATUS% <span id="statusTrend" style="font-size: 14px; margin-left: 4px;"></span></div>
              <div id="statusValue" class="db-value">102%</div>
            </div>
            <div class="status-icons-container">
              <div class="status-icons-box">
                <div class="status-icon green" id="ampelGreen"></div>
                <div class="status-icon orange" id="ampelOrange"></div>
                <div class="status-icon red" id="ampelRed"></div>
              </div>
            </div>
          </div>
          <div class="db-box">
            <div class="db-label">Auslastung</div>
            <div id="auslastung" class="db-value">0%</div>
          </div>
          <div class="db-box">
            <div class="db-label" style="margin-bottom: 8px;">Live</div>
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
              <div id="liveClock" style="font-size: 32px; font-weight: 700; color: #4a90e2; line-height: 1; letter-spacing: 1px;">09:39:04</div>
              <div id="liveDate" style="font-size: 13px; color: #666; font-weight: 600;">30.10.2025</div>
              <div id="liveZone" style="font-size: 10px; color: #999; font-weight: 500;">Deutschland (CET)</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gesamte Pool-Steuerung NUR im Fix-Modus sichtbar -->
    <div data-view="fix">
      <h2>Pool-Steuerung & Berechnung der ben√∂tigten MA</h2>
      <div class="pool-controls" style="background: white; padding: 8px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); margin-bottom: 6px;">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 6px;">
        <div>
          <label style="display: block; font-size: 10px; color: #666; margin-bottom: 2px;">Rate je MA (Send./Std)</label>
          <input id="rate" type="number" min="40" max="400" step="5" value="80" style="width: 100%; padding: 4px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
        </div>
        <div>
          <label style="display: block; font-size: 10px; color: #666; margin-bottom: 2px;">Fr√ºhdienst MA</label>
          <input id="frueh" type="number" value="32" style="width: 100%; padding: 4px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
        </div>
        <div>
          <label style="display: block; font-size: 10px; color: #666; margin-bottom: 2px;">Sp√§tdienst MA</label>
          <input id="spaet" type="number" value="7" style="width: 100%; padding: 4px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
        </div>
        <div>
          <label style="display: block; font-size: 10px; color: #666; margin-bottom: 2px;">Rotation/T√§ti (MA)</label>
          <input id="rot" type="number" min="0" max="40" value="4" style="width: 100%; padding: 4px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding-top: 6px; border-top: 1px solid #dee2e6;">
        <div>
          <label style="display: block; font-size: 10px; color: #666; margin-bottom: 3px;">Zuteilung basiert auf:</label>
          <div style="display: flex; gap: 8px;">
            <label style="font-size: 11px; cursor: pointer;">
              <input type="radio" name="basis" value="live" checked style="margin-right: 3px;"> Live
            </label>
            <label style="font-size: 11px; cursor: pointer;">
              <input type="radio" name="basis" value="fix" style="margin-right: 3px;"> Manuell (Fix)
            </label>
          </div>
        </div>
        <div>
          <label style="display: block; font-size: 10px; color: #666; margin-bottom: 3px;">Rotation aktiv:</label>
          <div style="display: flex; gap: 6px;">
            <label style="font-size: 10px; cursor: pointer;">
              <input type="checkbox" id="rotMorning" checked style="margin-right: 2px;"> Morning
            </label>
            <label style="font-size: 10px; cursor: pointer;">
              <input type="checkbox" id="rotMidday" checked style="margin-right: 2px;"> Midday
            </label>
            <label style="font-size: 10px; cursor: pointer;">
              <input type="checkbox" id="rotLate" style="margin-right: 2px;"> Late
            </label>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- Info-Bl√∂cke NUR im Live-Modus sichtbar -->
    <div data-view="live" style="margin-bottom: 6px;">

    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h2 style="margin: 0;">Pools</h2>
      <div class="pool-view-switch" id="poolViewSwitch">
        <button class="pool-view-btn active" data-view="live">Live</button>
        <button class="pool-view-btn" data-view="fix">Fix</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="pools-table" id="poolTable">
        <thead class="pools-header">
          <tr>
            <th style="text-align: left;">Pool</th>
            <th style="text-align: right;" data-view="fix">Fix-Vol</th>
            <th style="text-align: right;" data-view="live">Live-Vol</th>
            <th>Start</th>
            <th>Deadline</th>
            <th style="text-align: center;">Stunden</th>
            <th style="text-align: right;">Faktor</th>
            <th style="text-align: right;">Rate<br><span style="font-size: 11px; font-weight: normal; color: #6c757d;">(St√ºck/Std)</span></th>
            <th style="text-align: center;">Schicht</th>
            <th style="text-align: right;" data-view="fix">MA Fix</th>
            <th style="text-align: right;" data-view="live">Geplant MA</th>
            <th style="text-align: right;">Zugewiesen</th>
            <th style="text-align: right;">MA +/-</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- FIX Block -->
    <div data-view="fix" style="background: linear-gradient(135deg, #fffbf0 0%, #fff8e1 100%); border: 1px solid #ffc107; border-radius: 10px; padding: 12px 16px; margin-top: 8px; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.12);">
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #856404; margin-bottom: 4px; font-weight: 500;">Œ£ Fix-Vol</div>
          <div id="poolFixSum" style="font-weight: 700; font-size: 18px; color: #333;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #856404; margin-bottom: 4px; font-weight: 500;">Œ£ Plan (MA)</div>
          <div id="poolPlanFixSum" style="font-weight: 700; font-size: 18px; color: #333;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #4a90e2; margin-bottom: 4px; font-weight: 500;">Œ£ Fr√ºh</div>
          <div id="poolPlanFixFrSum" style="font-weight: 700; font-size: 18px; color: #4a90e2;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #17a2b8; margin-bottom: 4px; font-weight: 500;">Œ£ Sp√§t</div>
          <div id="poolPlanFixSpSum" style="font-weight: 700; font-size: 18px; color: #17a2b8;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #e67e22; margin-bottom: 4px; font-weight: 500;">Œ£ Rotation</div>
          <div id="poolPlanFixRotSum" style="font-weight: 700; font-size: 18px; color: #e67e22;">0</div>
        </div>
      </div>
    </div>

    <!-- LIVE Block -->
    <div data-view="live" style="background: linear-gradient(135deg, #e8f7fa 0%, #d4f1f9 100%); border: 1px solid #17a2b8; border-radius: 10px; padding: 12px 16px; margin-top: 8px; box-shadow: 0 2px 8px rgba(23, 162, 184, 0.15);">
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #0c5460; margin-bottom: 4px; font-weight: 500;">Œ£ Live-Vol</div>
          <div id="poolLiveSum" style="font-weight: 700; font-size: 18px; color: #0c5460;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #0c5460; margin-bottom: 4px; font-weight: 500;">Œ£ Plan (MA)</div>
          <div id="poolPlanLiveSum" style="font-weight: 700; font-size: 18px; color: #0c5460;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #4a90e2; margin-bottom: 4px; font-weight: 500;">Œ£ Fr√ºh</div>
          <div id="poolPlanLiveFrSum" style="font-weight: 700; font-size: 18px; color: #4a90e2;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #17a2b8; margin-bottom: 4px; font-weight: 500;">Œ£ Sp√§t</div>
          <div id="poolPlanLiveSpSum" style="font-weight: 700; font-size: 18px; color: #17a2b8;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 10px; color: #e67e22; margin-bottom: 4px; font-weight: 500;">Œ£ Rotation</div>
          <div id="poolPlanLiveRotSum" style="font-weight: 700; font-size: 18px; color: #e67e22;">0</div>
        </div>
      </div>
    </div>

  </div>

<script>
  let currentPoolView = 'live';

  function applyPoolView(view) {
    const normalized = view === 'fix' ? 'fix' : 'live';
    // Alle Elemente mit data-view umschalten (au√üer Buttons im pool-view-switch)
    const elements = document.querySelectorAll('[data-view]');
    elements.forEach(el => {
      // Skip buttons im pool-view-switch
      if (el.classList.contains('pool-view-btn')) return;
      
      const type = el.getAttribute('data-view');
      if (!type) return;
      el.classList.toggle('pool-view-hidden', type !== normalized);
    });
  }

  function setPoolView(view) {
    currentPoolView = view === 'fix' ? 'fix' : 'live';
    const switchWrapper = document.getElementById('poolViewSwitch');
    if (switchWrapper) {
      switchWrapper.querySelectorAll('.pool-view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === currentPoolView);
      });
    }
    applyPoolView(currentPoolView);
  }


  function getLocalDateString(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function saveDataForDate() {
    const dateStr = getLocalDateString(new Date());
    const data = {
      maFrueh: parseInt(document.getElementById('maFrueh')?.value, 10) || 0,
      maSpat: parseInt(document.getElementById('maSpat')?.value, 10) || 0,
      maRotation: parseInt(document.getElementById('maRotation')?.value, 10) || 0
    };
    localStorage.setItem(`einsatzplan_${dateStr}`, JSON.stringify(data));
  }

  async function loadDataForDate() {
    const dateStr = getLocalDateString(new Date());
    
    // Lade aus PostgreSQL (neue Methode)
    try {
      const response = await fetch(`/api/mitarbeiter/${dateStr}`);
      if (response.ok) {
        const data = await response.json();
        const fruehEl = document.getElementById('maFrueh');
        const spatEl = document.getElementById('maSpat');
        const rotationEl = document.getElementById('maRotation');
        
        if (fruehEl) fruehEl.value = data.maFrueh || 0;
        if (spatEl) spatEl.value = data.maSpat || 0;
        if (rotationEl) rotationEl.value = data.maRotation || 0;
        
        // Trigger Import aus Google Sheets
        if (typeof doImportMitarbeiterData === 'function') {
          doImportMitarbeiterData();
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden MA-Daten:', error);
    }
    
    berechnen();
  }

  function customAlert(message, title = 'Information', type = 'info') {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const iconMap = {
        'info': '‚ÑπÔ∏è',
        'success': '‚úì',
        'error': '‚ö†Ô∏è',
        'question': '?'
      };
      
      overlay.innerHTML = `
        <div class="modal-box">
          <div class="modal-header">
            <div class="modal-icon ${type}">
              ${iconMap[type] || iconMap.info}
            </div>
            <div class="modal-title">${title}</div>
          </div>
          <div class="modal-content">${message}</div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-primary">OK</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      overlay.querySelector('.modal-btn').focus();
      overlay.querySelector('.modal-btn').onclick = () => {
        overlay.remove();
        resolve(true);
      };
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
          resolve(true);
        }
      });
    });
  }

  function customConfirm(message, title = 'Best√§tigen', options = {}) {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const yesText = options.yesText || 'Ja';
      const noText = options.noText || 'Nein';
      const yesClass = options.danger ? 'modal-btn-danger' : 'modal-btn-success';
      
      overlay.innerHTML = `
        <div class="modal-box">
          <div class="modal-header">
            <div class="modal-icon question">
              ?
            </div>
            <div class="modal-title">${title}</div>
          </div>
          <div class="modal-content">${message}</div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" data-result="false">${noText}</button>
            <button class="modal-btn ${yesClass}" data-result="true">${yesText}</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      overlay.querySelectorAll('.modal-btn').forEach(btn => {
        btn.onclick = () => {
          const result = btn.dataset.result === 'true';
          overlay.remove();
          resolve(result);
        };
      });
      
      overlay.querySelector('[data-result="true"]').focus();
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
          resolve(false);
        }
      });
    });
  }

  function customPrompt(message, title = 'Eingabe', defaultValue = '') {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      overlay.innerHTML = `
        <div class="modal-box">
          <div class="modal-header">
            <div class="modal-icon question">
              ‚úé
            </div>
            <div class="modal-title">${title}</div>
          </div>
          <div class="modal-content">
            ${message}
            <input type="text" class="modal-input" value="${defaultValue}" />
          </div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" data-result="cancel">Abbrechen</button>
            <button class="modal-btn modal-btn-primary" data-result="ok">OK</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      const input = overlay.querySelector('.modal-input');
      input.focus();
      input.select();
      
      const handleResult = (result) => {
        if (result === 'ok') {
          const value = input.value;
          overlay.remove();
          resolve(value || null);
        } else {
          overlay.remove();
          resolve(null);
        }
      };
      
      overlay.querySelectorAll('.modal-btn').forEach(btn => {
        btn.onclick = () => handleResult(btn.dataset.result);
      });
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleResult('ok');
        }
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
          resolve(null);
        }
      });
    });
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
    document.getElementById('darkModeText').textContent = isDark ? 'Hellmodus' : 'Dunkelmodus';
  }

  function initDarkMode() {
    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'enabled') {
      document.body.classList.add('dark-mode');
      document.getElementById('darkModeText').textContent = 'Hellmodus';
    }
  }

  function initDevMode() {
    const devAccess = localStorage.getItem('devAccess');
    const btn = document.getElementById('devModeBtn');
    const btnText = document.getElementById('devModeText');
    const navSeite3 = document.getElementById('navSeite3');
    const navTest = document.getElementById('navTest');
    
    if (devAccess === 'granted') {
      // Entwickler-Modus ist aktiv
      if (btn) {
        btn.style.background = '#28a745';
        btn.style.borderColor = '#28a745';
      }
      if (btnText) {
        btnText.textContent = '‚úÖ Entwickler-Modus';
      }
      if (navSeite3) navSeite3.style.display = 'inline-block';
      if (navTest) navTest.style.display = 'inline-block';
    }
  }

  function toggleDevMode() {
    const devAccess = localStorage.getItem('devAccess');
    
    if (devAccess === 'granted') {
      // Entwickler-Modus deaktivieren
      if (confirm('Entwickler-Modus deaktivieren?')) {
        localStorage.removeItem('devAccess');
        location.reload();
      }
    } else {
      // Passwort abfragen
      const password = prompt('üîí Entwickler-Zugang\n\nBitte Passwort eingeben:', '');
      
      if (password === null) {
        return; // Abgebrochen
      }
      
      if (password === '123') {
        localStorage.setItem('devAccess', 'granted');
        location.reload();
      } else {
        alert('‚ùå Falsches Passwort!\n\nZugriff verweigert.');
      }
    }
  }

  function initDragAndDrop(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const tbody = table.querySelector('tbody');
    let draggedRow = null;

    tbody.querySelectorAll('tr[draggable="true"]').forEach(row => {
      row.addEventListener('dragstart', function(e) {
        draggedRow = row;
        row.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });

      row.addEventListener('dragend', function() {
        row.classList.remove('dragging');
        tbody.querySelectorAll('tr').forEach(r => r.classList.remove('drag-over'));
      });

      row.addEventListener('dragover', function(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(tbody, e.clientY);
        if (afterElement == null) {
          tbody.appendChild(draggedRow);
        } else {
          tbody.insertBefore(draggedRow, afterElement);
        }
      });

      row.addEventListener('dragenter', function(e) {
        e.preventDefault();
        if (row !== draggedRow) {
          row.classList.add('drag-over');
        }
      });

      row.addEventListener('dragleave', function() {
        row.classList.remove('drag-over');
      });

      row.addEventListener('drop', function(e) {
        e.preventDefault();
        row.classList.remove('drag-over');
      });
    });
  }

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('tr[draggable="true"]:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function berechnen() {
    const fruehName = document.getElementById('fruehName')?.textContent.trim() || 'FR√úH';
    const spatName = document.getElementById('spatName')?.textContent.trim() || 'SP√ÑT';
    const rotationName = document.getElementById('rotationName')?.textContent.trim() || 'ROTATION';

    document.querySelectorAll('.schicht-frueh').forEach(element => {
      element.textContent = fruehName;
    });

    document.querySelectorAll('.schicht-spat').forEach(element => {
      element.textContent = spatName;
    });

    document.querySelectorAll('.schicht-rotation').forEach(element => {
      element.textContent = rotationName;
    });

    updateDashboard();
  }

  let previousStatus = 0;

  function updateDashboard() {
    let frueh = parseInt(document.getElementById('maFrueh')?.value, 10) || 0;
    let spat = parseInt(document.getElementById('maSpat')?.value, 10) || 0;
    let rotation = parseInt(document.getElementById('maRotation')?.value, 10) || 0;
    let gesamt = frueh + spat + rotation;

    let poolRows = document.querySelectorAll('#poolsTable tbody tr');
    let benoetigteMA = 0;
    poolRows.forEach(row => {
      let wert = parseFloat(row.querySelector('.bedarf')?.textContent.replace(",", ".") || "0");
      benoetigteMA += isNaN(wert) ? 0 : wert;
    });

    let status = benoetigteMA ? Math.round(gesamt / benoetigteMA * 100) : 0;
    document.getElementById('statusValue').textContent = status + "%";

    // Trendanzeige
    const trendEl = document.getElementById('statusTrend');
    if (status > previousStatus) {
      trendEl.textContent = 'üìà';
      trendEl.style.color = '#29c46d';
    } else if (status < previousStatus) {
      trendEl.textContent = 'üìâ';
      trendEl.style.color = '#ef476f';
    } else {
      trendEl.textContent = '‚û°Ô∏è';
      trendEl.style.color = '#666';
    }
    previousStatus = status;

    // Auslastung (% der zugewiesenen MA relativ zu verf√ºgbaren MA)
    const auslastung = gesamt > 0 ? Math.round((benoetigteMA / gesamt) * 100) : 0;
    const auslastungEl = document.getElementById('auslastung');
    auslastungEl.textContent = auslastung + '%';
    auslastungEl.style.color = auslastung > 100 ? '#ef476f' : auslastung > 80 ? '#ffb020' : '#29c46d';

    // Kritische Pools (Anzahl der Pools mit negativem Delta)
    let criticalCount = 0;
    const poolTableRows = document.querySelectorAll('#poolTable tbody tr');
    poolTableRows.forEach(row => {
      const deltaCell = row.cells[row.cells.length - 2]; // Vorletztes Spalte ist Delta
      if (deltaCell) {
        const deltaText = deltaCell.textContent.trim();
        const deltaValue = parseInt(deltaText, 10);
        if (!isNaN(deltaValue) && deltaValue < 0) {
          criticalCount++;
        }
      }
    });
    const criticalEl = document.getElementById('criticalPools');
    if (criticalEl) {
      criticalEl.textContent = criticalCount;
      criticalEl.style.color = criticalCount > 0 ? '#ef476f' : '#29c46d';
    }

    const ampelGreen = document.getElementById('ampelGreen');
    const ampelOrange = document.getElementById('ampelOrange');
    const ampelRed = document.getElementById('ampelRed');

    ampelGreen.classList.remove('active');
    ampelOrange.classList.remove('active');
    ampelRed.classList.remove('active');

    if (status >= 100) {
      ampelGreen.classList.add('active');
    } else if (status >= 80) {
      ampelOrange.classList.add('active');
    } else {
      ampelRed.classList.add('active');
    }
  }

  function startClock() {
    function tick() {
      const now = new Date();
      
      // Zeit
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('liveClock').textContent = h + ":" + m + ":" + s;
      
      // Datum
      const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const weekday = weekdays[now.getDay()];
      document.getElementById('liveDate').textContent = `${weekday}, ${day}.${month}.${year}`;
      
      // Zeitzone
      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const offset = -now.getTimezoneOffset() / 60;
      const offsetStr = offset >= 0 ? `+${offset}` : `${offset}`;
      document.getElementById('liveZone').textContent = `${timezone} (UTC${offsetStr})`;
      
      setTimeout(tick, 1000);
    }
    tick();
  }


  let timelineBoxes = [];
  let boxIdCounter = 1;

  function initTimeline() {
  }

  function initPoolsGrid() {
  }

  function setupDragItem(item) {
  }

  function renderTimelineBoxes() {
  }

  function deleteBox(id) {
  }

  function saveTimelineData() {
  }

  async function importFromExcel() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx,.xls,.csv';
    
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.name.endsWith('.csv')) {
        await loadCSVFile(file);
      } else {
        await loadExcelFile(file);
      }
    };
    
    input.click();
  }

  async function loadExcelFile(file) {
    document.querySelector('.modal-overlay')?.remove();
    
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'modal-overlay';
    loadingOverlay.innerHTML = `
      <div class="modal-box" style="max-width: 400px;">
        <div class="modal-header">
          <div class="modal-icon info">‚è≥</div>
          <div class="modal-title">Wochenplan wird geladen...</div>
        </div>
        <div class="modal-content" style="text-align: center; padding: 30px;">
          <div style="margin: 20px 0;">Analysiere Excel-Struktur...</div>
        </div>
      </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    try {
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
      
      if (!data || data.length === 0) {
        loadingOverlay.remove();
        await customAlert('Die Excel-Datei enth√§lt keine Daten.', 'Keine Daten', 'info');
        return;
      }
      const datumZeile = data[0] || [];
      const datumSpalten = [];
      
      for (let col = 1; col < datumZeile.length; col++) {
        const zelle = datumZeile[col];
        if (zelle && (zelle.toString().includes('/') || zelle.toString().match(/\d{2}\.\d{2}/) || zelle.toString().match(/^\d{2}\s/))) {
          datumSpalten.push({ col, datum: zelle.toString() });
        }
      }
      
      if (datumSpalten.length === 0) {
        loadingOverlay.remove();
        await customAlert('Keine Datumsspalten gefunden.\n\nBitte stellen Sie sicher, dass die erste Zeile Datumsangaben enth√§lt (z.B. "01/2025" oder "Mo 01.01").', 'Fehler', 'error');
        return;
      }
      
      const overlay2 = document.createElement('div');
      overlay2.className = 'modal-overlay';
      overlay2.innerHTML = `
        <div class="modal-box" style="max-width: 500px;">
          <div class="modal-header">
            <div class="modal-icon info">üìÖ</div>
            <div class="modal-title">Tag ausw√§hlen</div>
          </div>
          <div class="modal-content">
            <p>W√§hlen Sie einen Tag aus dem Wochenplan:</p>
            ${datumSpalten.map((ds, idx) => `
              <div style="padding: 10px; border: 1px solid #dee2e6; border-radius: 6px; margin: 8px 0; cursor: pointer; transition: all 0.2s ease;" 
                   onmouseover="this.style.background='#f8f9fa'" 
                   onmouseout="this.style.background='white'"
                   onclick="selectDayForImport(${ds.col}, '${ds.datum}')">
                <strong>${ds.datum}</strong>
              </div>
            `).join('')}
          </div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button>
          </div>
        </div>
      `;
      loadingOverlay.remove();
      document.body.appendChild(overlay2);
      
      window.selectDayForImport = function(spalteIndex, datum) {
        overlay2.remove();
        const loadingOverlay2 = document.createElement('div');
        loadingOverlay2.className = 'modal-overlay';
        loadingOverlay2.innerHTML = `
          <div class="modal-box" style="max-width: 400px;">
            <div class="modal-header">
              <div class="modal-icon info">‚è≥</div>
              <div class="modal-title">Importiere ${datum}...</div>
            </div>
            <div class="modal-content" style="text-align: center; padding: 30px;">
              <div style="margin: 20px 0;">Lese Schichtplan...</div>
            </div>
          </div>
        `;
        document.body.appendChild(loadingOverlay2);
        
        let schichtenGefunden = 0;
        timelineBoxes = [];
        boxIdCounter = 1;
        
        for (let row = 1; row < data.length; row++) {
          const zeile = data[row];
          const abteilung = zeile[0]?.toString().trim();
          
          if (!abteilung || abteilung.length === 0) continue;
          
          const zelle = zeile[spalteIndex];
          if (!zelle) continue;
          
          const zellenText = zelle.toString().trim().toUpperCase();
          if (zellenText.length === 0 || zellenText === '-') continue;
        
        let schichtTyp = 'ALLGEMEIN';
        let schichtClass = 'schicht-frueh';
        let zeitStart = '06:00';
        let zeitEnde = '14:00';
        
        if (zellenText.includes('FR√úH')) {
          schichtTyp = 'FR√úH';
          schichtClass = 'schicht-frueh';
          zeitStart = '06:00';
          zeitEnde = '14:00';
        } else if (zellenText.includes('SP√ÑT')) {
          schichtTyp = 'SP√ÑT';
          schichtClass = 'schicht-spat';
          zeitStart = '14:00';
          zeitEnde = '22:00';
        } else if (zellenText.includes('NACHT')) {
          schichtTyp = 'NACHT';
          schichtClass = 'schicht-nacht';
          zeitStart = '22:00';
          zeitEnde = '06:00';
        } else if (zellenText.includes('T√ÑTI')) {
          schichtTyp = 'T√ÑTI';
          schichtClass = 'schicht-taeti';
          zeitStart = '08:00';
          zeitEnde = '16:00';
        }
        
        const zeitMatch = zellenText.match(/(\d{2}:\d{2})/g);
        if (zeitMatch && zeitMatch.length >= 2) {
          zeitStart = zeitMatch[0];
          zeitEnde = zeitMatch[1];
        } else if (zeitMatch && zeitMatch.length === 1) {
          zeitStart = zeitMatch[0];
        }
        
        const startStunde = parseInt(zeitStart.split(':')[0]);
        const endeStunde = parseInt(zeitEnde.split(':')[0]);
        const canvasBreite = document.getElementById('timelineCanvas')?.offsetWidth || 800;
        const stundenProTag = 14;
        const pixelProStunde = canvasBreite / stundenProTag;
        
        const offsetStunde = 6;
        let xPos = (startStunde - offsetStunde) * pixelProStunde;
        let breite = ((endeStunde > startStunde ? endeStunde - startStunde : 8)) * pixelProStunde;
        
        if (endeStunde < startStunde) {
          breite = ((24 - startStunde + endeStunde)) * pixelProStunde;
        }
        
        xPos = Math.max(0, Math.min(xPos, canvasBreite - 50));
        breite = Math.max(50, Math.min(breite, canvasBreite - xPos));
        
        const yPos = (row - 1) * 40;
        
        const newBox = {
          id: boxIdCounter++,
          type: 'schicht',
          value: `${abteilung}`,
          className: schichtClass,
          x: xPos,
          y: yPos,
          width: breite,
          date: getLocalDateString(currentViewDate),
          abteilung: abteilung,
          schicht: schichtTyp,
          zeitStart: zeitStart,
          zeitEnde: zeitEnde
        };
        
        timelineBoxes.push(newBox);
        schichtenGefunden++;
      }
      
        saveTimelineData();
        renderTimelineBoxes();
        
        loadingOverlay2.remove();
        customAlert(
          `‚úÖ ${datum} erfolgreich importiert!\n\n${schichtenGefunden} Schichten wurden zur Timeline hinzugef√ºgt.`, 
          'Import erfolgreich', 
          'success'
        );
      };
      
    } catch (error) {
      loadingOverlay.remove();
      console.error('Fehler beim Laden des Wochenplans:', error);
      await customAlert('Fehler beim Laden des Wochenplans.\n\nFehler: ' + error.message + '\n\nBitte versuchen Sie es erneut oder √ºberpr√ºfen Sie das Excel-Format.', 'Fehler', 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    initDragAndDrop('einsatzplanTable');
    initDragAndDrop('poolsTable');

    loadDataForDate();
    
    berechnen();
    startClock();
    initDarkMode();
    initDevMode();
    initPoolsGrid();

    document.querySelectorAll('#schichtenGrid .drag-item').forEach(item => {
      setupDragItem(item);
    });

    ['fruehName', 'spatName', 'rotationName'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', berechnen);
        element.addEventListener('blur', berechnen);
      }
    });

    ['maFrueh', 'maSpat', 'maRotation'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', () => {
          berechnen();
          saveDataForDate();
          rebuildPools(); // Pools neu berechnen wenn Dashboard-Werte sich √§ndern
        });
      }
    });

    const viewSwitch = document.getElementById('poolViewSwitch');
    if (viewSwitch) {
      viewSwitch.querySelectorAll('.pool-view-btn').forEach(btn => {
        btn.addEventListener('click', () => setPoolView(btn.dataset.view));
      });
      setPoolView(currentPoolView);
    }
  });

  async function loadCSVFile(file) {
    document.querySelector('.modal-overlay')?.remove();
    
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'modal-overlay';
    loadingOverlay.innerHTML = `
      <div class="modal-box" style="max-width: 400px;">
        <div class="modal-header">
          <div class="modal-icon info">‚è≥</div>
          <div class="modal-title">CSV wird geladen...</div>
        </div>
        <div class="modal-content" style="text-align: center; padding: 30px;">
          <div style="margin: 20px 0;">Analysiere Schichtplan...</div>
        </div>
      </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    try {
      const text = await file.text();
      const lines = text.split('\n').map(line => line.split(';'));
      
      if (lines.length < 5) {
        loadingOverlay.remove();
        await customAlert('Die CSV-Datei enth√§lt nicht genug Daten.', 'Fehler', 'error');
        return;
      }
      
      const dateRow = lines[3] || [];
      const datumSpalten = [];
      
      for (let col = 1; col < dateRow.length; col++) {
        const datum = dateRow[col]?.trim();
        if (datum && datum.match(/\d{2}\.\d{2}\./)) {
          datumSpalten.push({ col, datum });
        }
      }
      
      if (datumSpalten.length === 0) {
        loadingOverlay.remove();
        await customAlert('Keine Datumsangaben in der CSV gefunden.', 'Fehler', 'error');
        return;
      }
      
      const overlay2 = document.createElement('div');
      overlay2.className = 'modal-overlay';
      overlay2.innerHTML = `
        <div class="modal-box" style="max-width: 500px;">
          <div class="modal-header">
            <div class="modal-icon info">üìÖ</div>
            <div class="modal-title">Tag ausw√§hlen</div>
          </div>
          <div class="modal-content" style="max-height: 500px; overflow-y: auto;">
            <p style="margin-bottom: 15px; color: #6c757d;">
              <strong>${datumSpalten.length} Tage</strong> gefunden - W√§hlen Sie einen Tag:
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
            ${datumSpalten.map((ds, idx) => `
              <div style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; text-align: center; font-size: 13px;" 
                   onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#17a2b8'" 
                   onmouseout="this.style.background='white'; this.style.borderColor='#dee2e6'"
                   onclick="selectDayForCSVImport(${ds.col}, '${ds.datum}', ${idx})">
                <strong>${ds.datum}</strong>
              </div>
            `).join('')}
            </div>
          </div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button>
          </div>
        </div>
      `;
      loadingOverlay.remove();
      document.body.appendChild(overlay2);
      
      window.csvData = lines;
      window.csvDatumSpalten = datumSpalten;
      
      window.selectDayForCSVImport = function(spalteIndex, datum) {
        overlay2.remove();
        
        const loadingOverlay2 = document.createElement('div');
        loadingOverlay2.className = 'modal-overlay';
        loadingOverlay2.innerHTML = `
          <div class="modal-box" style="max-width: 400px;">
            <div class="modal-header">
              <div class="modal-icon info">‚è≥</div>
              <div class="modal-title">Importiere ${datum}...</div>
            </div>
            <div class="modal-content" style="text-align: center; padding: 30px;">
              <div style="margin: 20px 0;">Z√§hle Mitarbeiter...</div>
            </div>
          </div>
        `;
        document.body.appendChild(loadingOverlay2);
        
        let countImpf = 0;
        let countHtvo = 0;
        let countImp = 0;
        let countSpat = 0;
        let countHtna = 0;
        let countImps = 0;
        
        for (let row = 5; row < lines.length; row++) {
          const zeile = lines[row];
          const mitarbeiter = zeile[0]?.toString().trim();
          
          if (!mitarbeiter || mitarbeiter.length === 0) continue;
          
          let schichtCode = zeile[spalteIndex]?.toString().trim().toUpperCase() || '';
          
          if (!schichtCode || schichtCode === '-' || schichtCode === '') continue;
          
          schichtCode = schichtCode.replace(/^\d+\s*/, '');
          
          if (schichtCode === 'FT' || schichtCode === 'A' || schichtCode === 'U' || schichtCode === 'K') continue;
          
          if (schichtCode === 'IMPF' || schichtCode.startsWith('IMPF')) {
            countImpf++;
          } else if (schichtCode === 'HTVO' || schichtCode.startsWith('HTVO')) {
            countHtvo++;
          } else if (schichtCode === 'IMP' && !schichtCode.startsWith('IMPF') && !schichtCode.startsWith('IMPS')) {
            countImp++;
          } else if (schichtCode === 'SPAT' || schichtCode === 'SP√ÑT' || schichtCode.startsWith('SPAT')) {
            countSpat++;
          } else if (schichtCode === 'HTNA' || schichtCode.startsWith('HTNA')) {
            countHtna++;
          } else if (schichtCode === 'IMPS' || schichtCode.startsWith('IMPS')) {
            countImps++;
          }
        }
        
        document.getElementById('maImpf').value = countImpf;
        document.getElementById('maHtvo').value = countHtvo;
        document.getElementById('maImp').value = countImp;
        document.getElementById('maSpat').value = countSpat;
        document.getElementById('maHtna').value = countHtna;
        document.getElementById('maImps').value = countImps;
        
        berechnen();
        saveDataForDate();
        
        loadingOverlay2.remove();
        customAlert(
          `‚úÖ ${datum} erfolgreich importiert!\n\nIMPF: ${countImpf}\nHTVO: ${countHtvo}\nIMP: ${countImp}\nSPAT: ${countSpat}\nHTNA: ${countHtna}\nIMPS: ${countImps}`, 
          'Import erfolgreich', 
          'success'
        );
      };
      
    } catch (error) {
      loadingOverlay.remove();
      console.error('Fehler beim Laden der CSV:', error);
      await customAlert('Fehler beim Laden der CSV-Datei. Bitte √ºberpr√ºfen Sie das Format.', 'Fehler', 'error');
    }
  }

  // ========== POOL MANAGEMENT SYSTEM ==========
  // Default Pools
  const defaultPools = [
    {name:"FR bis 08:45",start:"06:00",deadline:"08:45",fixVol:1600,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"DE bis 10:00",start:"06:00",deadline:"10:00",fixVol:3000,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"EMS bis 13:30 und 17:00",start:"06:00",deadline:"14:00",fixVol:500,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"Luftverkehr bis 16:00",start:"06:00",deadline:"16:00",fixVol:1500,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"Endpunkt bis 17:00",start:"06:00",deadline:"17:00",fixVol:1400,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"Kleinwaren MUE ab 11:00",start:"06:00",deadline:"11:00",fixVol:4000,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"NL bis 11:00",start:"06:00",deadline:"11:00",fixVol:800,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"DK+NO+SE+CZ+LU+HU+IS bis 11:00",start:"06:00",deadline:"11:00",fixVol:400,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"JP+AU+HK+TH+CA+US+IT",start:"06:00",deadline:"19:00",fixVol:2000,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"CH Retouren bis 17:00",start:"06:00",deadline:"17:00",fixVol:800,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"WA Pakete bis 13:00",start:"06:00",deadline:"13:00",fixVol:1000,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"WA Kleinwaren MUE bis 11:00",start:"06:00",deadline:"11:00",fixVol:1500,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"BE+GB bis 15:00",start:"06:00",deadline:"15:00",fixVol:1300,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"AT bis 16:30",start:"06:00",deadline:"16:30",fixVol:600,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"EMK PRA BackOffice1",start:"06:00",deadline:"17:00",fixVol:500,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"AVIS PRA BackOffice1",start:"06:00",deadline:"17:00",fixVol:500,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"ZB Pakete Restbestand",start:"06:00",deadline:"17:00",fixVol:1200,liveVol:0,factor:1.0,rate:80,useRotation:true},
    {name:"ZB Pakete heute",start:"06:00",deadline:"17:00",fixVol:1500,liveVol:0,factor:1.0,rate:80,useRotation:true}
  ];
  
  // Lade Pools aus Backend (Standard-Pools aus server.py)
  async function loadPoolsFromJSON() {
    try {
      const response = await fetch('/api/pools');
      if (response.ok) {
        const jsonData = await response.json();
        console.log('üóÑÔ∏è Pools vom Backend geladen:', jsonData.length);
        return jsonData;
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Fehler beim Laden vom Backend:', e);
    }
    console.log('üì¶ Standard-Pools geladen (Fallback)');
    return JSON.parse(JSON.stringify(defaultPools)); // Deep copy
  }

  // Lade Pools (Backend hat Priorit√§t, localStorage als Fallback)
  function loadPools() {
    // loadPoolsFromJSON() l√§dt jetzt vom Backend
    // Dies wird nur als Fallback verwendet wenn async Laden fehlschl√§gt
    console.log('üì¶ Nutze Standard-Pools (werden durch Backend √ºberschrieben)');
    return JSON.parse(JSON.stringify(defaultPools)); // Deep copy
  }
  
  // Speichere Pools ins Google Sheet (Web ‚Üí Google Sheet)
  async function savePools() {
    try {
      // 1. Speichere in localStorage (als Backup)
      const jsonString = JSON.stringify(pools, null, 2);
      localStorage.setItem('pools_data', jsonString);
      
      // 2. Speichere direkt ins Google Sheet (Web ‚Üí Google Sheet)
      const success = await savePoolsToGoogleSheets();
      
      if (success) {
        console.log('‚úÖ Pools erfolgreich ins Google Sheet gespeichert');
      } else {
        console.warn('‚ö†Ô∏è Fehler beim Speichern ins Google Sheet');
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Fehler beim Speichern:', e);
    }
  }

  // Download Pools als JSON-Datei
  function downloadPoolsJSON() {
    try {
      const dataStr = JSON.stringify(pools, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'pools-config.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      console.log('üì• pools-config.json heruntergeladen');
    } catch (e) {
      console.error('‚ùå Fehler beim Download:', e);
      alert('Fehler beim Download der JSON-Datei');
    }
  }
  
  let pools = loadPools();
  
  // Auto-Refresh Konfiguration - LIVE!
  const AUTO_REFRESH_SECONDS = 1; // Jede Sekunde automatisch Google Sheets abfragen - LIVE!
  let autoRefreshEnabled = false;
  let autoRefreshInterval = null;

  const el_pool = s => document.querySelector(s);
  
  function toHours(hm){
    if (!hm || hm === '') return 0;
    const parts = hm.split(':').map(Number);
    const h = parts[0] || 0;
    const m = parts[1] || 0;
    return h + m/60;
  }
  
  function hoursBetween(s,e){
    if (!s || !e) return 0.01;
    return Math.max(0.01,toHours(e)-toHours(s));
  }
  
  function formatHoursToHMS(hours) {
    const totalSeconds = Math.round(hours * 3600);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }
  
  function needMA(vol,start,dead,rate){
    const h=hoursBetween(start,dead);
    return Math.ceil(vol/(rate*h));
  }
  
  function blockKey(start, dead){
    const s = toHours(start);
    const d = toHours(dead);
    const earlyEnd = 15.5; // 15:30 ist die Grenze zwischen FR√úH und SP√ÑT
    
    // Wenn Pool vor 15:30 endet ‚Üí nur FR√úH
    if (d <= earlyEnd) return 'morning';
    // Wenn Pool nach 15:30 startet ‚Üí nur SP√ÑT
    if (s >= earlyEnd) return 'late';
    // Wenn Pool √ºber 15:30 hinweg geht ‚Üí FR√úH+SP√ÑT
    return 'midday';
  }
  
  function badge_pool(delta){
    if(delta>=0) return '<span style="color: #29c46d; font-weight: 600;">‚úì OK</span>';
    if(delta>-3) return '<span style="color: #ffb020; font-weight: 600;">‚ö† kritisch</span>';
    return '<span style="color: #ef476f; font-weight: 600;">‚úó Engpass</span>';
  }

  function proportionalAssign(needs,cap){
    const total=needs.reduce((a,b)=>a+b,0);
    if(total<=0||cap<=0) return needs.map(_=>0);
    let raw=needs.map(n=>cap*(n/total));
    let assign=raw.map(x=>Math.floor(x));
    let remain=cap-assign.reduce((a,b)=>a+b,0);
    const frac=raw.map((x,i)=>({i,f:x-Math.floor(x)})).sort((a,b)=>b.f-a.f);
    for(let k=0;k<remain;k++){ if(frac[k]) assign[frac[k].i]++; }
    return assign;
  }

  function rebuildPools(){
    // ‚è∏Ô∏è Verhindere Re-Render wenn Nutzer gerade in einem Input-Feld tippt
    const activeElement = document.activeElement;
    if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
      const isPoolTableInput = activeElement.closest('#poolTable');
      if (isPoolTableInput) {
        console.log('‚è∏Ô∏è Re-Render √ºbersprungen (Nutzer tippt)');
        return; // Skip rebuild wenn fokussiert
      }
    }
    
    const rateInput = el_pool('#rate');
    const rate = rateInput ? +rateInput.value : 80;
    
    // Im Live-Modus: Werte vom Einsatzplan (Dashboard)
    // Im Fix-Modus: Werte von den Pool-Steuerungs-Eingabefeldern
    let frueh, spaet, rot;
    
    if (currentPoolView === 'live') {
      // Live: Nutze die Dashboard-Werte
      const maFruehEl = document.getElementById('maFrueh');
      const maSpatEl = document.getElementById('maSpat');
      const maRotationEl = document.getElementById('maRotation');
      
      frueh = maFruehEl ? +maFruehEl.value : 0;
      spaet = maSpatEl ? +maSpatEl.value : 0;
      rot = maRotationEl ? +maRotationEl.value : 0;
    } else {
      // Fix: Nutze die Pool-Steuerungs-Felder
      const fruehInput = el_pool('#frueh');
      const spaetInput = el_pool('#spaet');
      const rotInput = el_pool('#rot');
      
      frueh = fruehInput ? +fruehInput.value : 0;
      spaet = spaetInput ? +spaetInput.value : 0;
      rot = rotInput ? +rotInput.value : 0;
    }
    
    // Rotation Aktivierung
    let rotActive;
    
    if (currentPoolView === 'live') {
      // Live: Rotation ist flexibel - f√ºr Morning und Midday verf√ºgbar
      rotActive = {
        morning: rot,
        midday: rot,
        late: 0
      };
    } else {
      // Fix: Nutze die Checkboxen
      const rotMorningCheck = el_pool('#rotMorning');
      const rotMiddayCheck = el_pool('#rotMidday');
      const rotLateCheck = el_pool('#rotLate');
      
      rotActive = {
        morning: rotMorningCheck ? (rotMorningCheck.checked ? rot : 0) : 0,
        midday: rotMiddayCheck ? (rotMiddayCheck.checked ? rot : 0) : 0,
        late: rotLateCheck ? (rotLateCheck.checked ? rot : 0) : 0
      };
    }
    
    // Basis wird vom currentPoolView bestimmt (Live oder Fix Button)
    const basis = currentPoolView;

    // Sortiere Pools nach Deadline (fr√ºh -> sp√§t)
    const timeToMinutes = (time) => {
      if (!time || time === '') return 0;
      const parts = time.split(':').map(Number);
      const h = parts[0] || 0;
      const m = parts[1] || 0;
      return h * 60 + m;
    };
    
    const data=pools
      .map(p=>{
        // Jeder Pool hat seine eigene Rate (Standard: 80)
        const poolRate = p.rate || 80;
        const fixNeed=needMA(p.fixVol*p.factor,p.start,p.deadline,poolRate);
        const liveNeed=needMA(p.liveVol*p.factor,p.start,p.deadline,poolRate);
        const blk=blockKey(p.start, p.deadline);
        const baseNeed=(basis==='live')?liveNeed:fixNeed;
        return {...p,fixNeed,liveNeed,baseNeed,blk};
      })
      .sort((a, b) => timeToMinutes(a.deadline) - timeToMinutes(b.deadline));

    // Kapazit√§ten F√úR POOLS MIT ROTATION (bekommen auch Rotation-MA)
    const capsWithRot={
      morning: frueh + rotActive.morning,
      midday:  frueh + spaet + rotActive.midday,
      late:    spaet + rotActive.late
    };
    
    // Kapazit√§ten F√úR POOLS OHNE ROTATION (bekommen NUR Fr√ºh/Sp√§t)
    const capsWithoutRot={
      morning: frueh,
      midday:  frueh + spaet,
      late:    spaet
    };

    // Teile Pools in zwei Gruppen: MIT und OHNE Rotation
    const needsByBlock={
      morning:{withRot:[],withoutRot:[]},
      midday:{withRot:[],withoutRot:[]},
      late:{withRot:[],withoutRot:[]}
    };
    const idxByBlock={
      morning:{withRot:[],withoutRot:[]},
      midday:{withRot:[],withoutRot:[]},
      late:{withRot:[],withoutRot:[]}
    };
    
    data.forEach((p,i)=>{ 
      if(p.useRotation){
        needsByBlock[p.blk].withRot.push(p.baseNeed);
        idxByBlock[p.blk].withRot.push(i);
      } else {
        needsByBlock[p.blk].withoutRot.push(p.baseNeed);
        idxByBlock[p.blk].withoutRot.push(i);
      }
    });
    
    // Separate Zuteilungen f√ºr MIT und OHNE Rotation
    const assignWithRot={morning:[],midday:[],late:[]};
    const assignWithoutRot={morning:[],midday:[],late:[]};
    
    assignWithRot.morning=proportionalAssign(needsByBlock.morning.withRot,capsWithRot.morning);
    assignWithRot.midday =proportionalAssign(needsByBlock.midday.withRot,capsWithRot.midday);
    assignWithRot.late   =proportionalAssign(needsByBlock.late.withRot,capsWithRot.late);
    
    assignWithoutRot.morning=proportionalAssign(needsByBlock.morning.withoutRot,capsWithoutRot.morning);
    assignWithoutRot.midday =proportionalAssign(needsByBlock.midday.withoutRot,capsWithoutRot.midday);
    assignWithoutRot.late   =proportionalAssign(needsByBlock.late.withoutRot,capsWithoutRot.late);

    const tb=el_pool('#poolTable tbody');
    if(tb) {
      tb.innerHTML='';
      
      data.forEach((p,pi)=>{
        // Hole die richtige Zuteilung (MIT oder OHNE Rotation)
        let assigned = 0;
        if(p.useRotation){
          const pos=idxByBlock[p.blk].withRot.indexOf(pi);
          assigned=pos>=0?(p.blk==='morning'?assignWithRot.morning[pos]:p.blk==='midday'?assignWithRot.midday[pos]:assignWithRot.late[pos]):0;
        } else {
          const pos=idxByBlock[p.blk].withoutRot.indexOf(pi);
          assigned=pos>=0?(p.blk==='morning'?assignWithoutRot.morning[pos]:p.blk==='midday'?assignWithoutRot.midday[pos]:assignWithoutRot.late[pos]):0;
        }
        const needForDelta=p.baseNeed;
        const delta=assigned-needForDelta;

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="text-align: left;">
            <input type="text" value="${p.name}" data-pool="${p.name}" data-key="name" 
                   style="width: 160px; padding: 4px 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px;">
          </td>
          <td class="col-fix" data-view="fix" style="text-align: right;">
            <input type="number" value="${p.fixVol}" data-pool="${p.name}" data-key="fixVol"
                   style="width: 90px; padding: 4px 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; text-align: right;">
          </td>
          <td class="col-live" data-view="live" style="text-align: right;">
            <input type="number" value="${p.liveVol}" data-pool="${p.name}" data-key="liveVol" readonly
                   style="width: 90px; padding: 4px 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; text-align: right; background: #e8f4f8; color: #4a90e2; font-weight: 600; cursor: not-allowed;">
          </td>
          <td>
            <input type="text" value="${p.start}" data-pool="${p.name}" data-key="start"
                   placeholder="HH:MM"
                   style="width: 80px; padding: 4px 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; text-align: center;">
          </td>
          <td>
            <input type="text" value="${p.deadline}" data-pool="${p.name}" data-key="deadline"
                   placeholder="HH:MM"
                   style="width: 80px; padding: 4px 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; text-align: center;">
          </td>
          <td style="text-align: center; font-weight: 600; color: #666;">
            ${formatHoursToHMS(toHours(p.deadline) - toHours(p.start))}
          </td>
          <td style="text-align: right;">
            <select data-pool="${p.name}" data-key="factor" style="width: 70px; padding: 4px 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px;">
              <option value="1" ${p.factor === 1 ? 'selected' : ''}>1</option>
              <option value="1.5" ${p.factor === 1.5 ? 'selected' : ''}>1.5</option>
              <option value="2" ${p.factor === 2 ? 'selected' : ''}>2</option>
            </select>
          </td>
          <td style="text-align: right;">
            <input type="number" value="${p.rate || 80}" min="10" max="100" data-pool="${p.name}" data-key="rate"
                   placeholder="80"
                   style="width: 70px; padding: 4px 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; text-align: right;">
          </td>
          <td style="text-align: center;">
            <div style="display: inline-flex; gap: 4px; align-items: center; justify-content: center; position: relative;">
              ${p.blk === 'morning' ? '<span style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; box-shadow: 0 2px 4px rgba(74,144,226,0.3); display: inline-flex; align-items: center; gap: 4px;">FR√úH</span>' : 
                p.blk === 'midday' ? '<span style="background: linear-gradient(90deg, #4a90e2 50%, #17a2b8 50%); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; box-shadow: 0 2px 4px rgba(74,144,226,0.3); display: inline-flex; align-items: center; gap: 4px;">FR√úH+SP√ÑT</span>' :
                '<span style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; box-shadow: 0 2px 4px rgba(23,162,184,0.3); display: inline-flex; align-items: center; gap: 4px;">SP√ÑT</span>'}
              ${!p.useRotation ? 
                '<button onclick="toggleRotation(\'' + p.name.replace(/'/g, "\\'") + '\')" style="background: #29c46d; color: white; border: none; width: 16px; height: 16px; border-radius: 50%; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 0; line-height: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: all 0.2s ease; margin-left: -6px; opacity: 0.85;" onmouseover="this.style.opacity=\'1\'; this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.15)\';" onmouseout="this.style.opacity=\'0.85\'; this.style.boxShadow=\'0 1px 2px rgba(0,0,0,0.1)\';">+</button>' : 
                '<span onclick="toggleRotation(\'' + p.name.replace(/'/g, "\\'") + '\')" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; box-shadow: 0 2px 4px rgba(255,152,0,0.4); margin-left: -4px; cursor: pointer; transition: all 0.15s ease;" onmouseover="this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 3px 8px rgba(255,152,0,0.6)\';" onmouseout="this.style.transform=\'scale(1)\'; this.style.boxShadow=\'0 2px 4px rgba(255,152,0,0.4)\';">ROT</span>'}
            </div>
          </td>
          <td class="col-fix" data-view="fix" style="text-align: right; font-weight: 600;">${p.fixNeed}</td>
          <td class="col-live" data-view="live" style="text-align: right; font-weight: 600;">${p.liveNeed}</td>
          <td style="text-align: right; font-weight: 600; color: #4a90e2;">${assigned}</td>
          <td style="text-align: right; font-weight: 600; color: ${delta>=0?'#29c46d':'#ef476f'};">${(delta>0?'+':'')+delta}</td>
          <td>${badge_pool(delta)}</td>
        `;
        tb.appendChild(tr);
      });

      applyPoolView(currentPoolView);
      
      // Dashboard aktualisieren nach Pool-Rebuild
      updateDashboard();
    }

    // Zeitvalidierungs-Funktion
    function validateTimeInput(input) {
      const key = input.getAttribute('data-key');
      if (key === 'start' || key === 'deadline') {
        let value = input.value.trim();
        if (!value) return;
        
        // Automatisches Format-Fixing (z.B. "7:30" -> "07:30")
        const parts = value.split(':');
        if (parts.length === 2) {
          let hours = parseInt(parts[0], 10);
          let minutes = parseInt(parts[1], 10);
          
          // Korrigiere ung√ºltige Minuten
          if (isNaN(minutes) || minutes < 0) minutes = 0;
          if (minutes > 59) minutes = 59;
          
          // Korrigiere ung√ºltige Stunden (6-19)
          if (isNaN(hours) || hours < 6) hours = 6;
          if (hours > 19) hours = 19;
          
          // Formatiere als HH:MM
          const formatted = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
          input.value = formatted;
        } else {
          // Ung√ºltiges Format -> setze auf 06:00
          input.value = '06:00';
        }
      }
    }
    
    document.querySelectorAll('#poolTable tbody input, #poolTable tbody select').forEach(inp=>{
      inp.addEventListener('change',e=>{
        // Ignoriere readonly Felder (Live-Vol)
        if(e.target.hasAttribute('readonly')) {
          return;
        }
        
        // Validiere Zeit-Felder vor dem Speichern
        validateTimeInput(e.target);
        
        const pool_name=e.target.getAttribute('data-pool');
        const key=e.target.getAttribute('data-key');
        const p=pools.find(x=>x.name===pool_name);
        
        if(p){ 
          if(key === 'useRotation') {
            // Checkbox: nutze .checked
            p[key] = e.target.checked;
          } else if(key === 'name' || key === 'start' || key === 'deadline') {
            // Text/Time Felder
            p[key] = e.target.value;
          } else {
            const val = e.target.value;
            p[key] = isNaN(+val) ? 0 : +val;
          }
          savePools(); // Speichere nach jeder √Ñnderung
          rebuildPools(); 
        }
      });
    });

    // Update Summen - SEPARATE f√ºr FIX und LIVE
    try{
      const sumFix  = pools.reduce((a,p)=>a+(+p.fixVol||0),0);
      const sumLive = pools.reduce((a,p)=>a+(+p.liveVol||0),0);
      
      // Berechne FIX-Bedarf (Total MA needed)
      let totalNeedFix = 0;
      
      // Berechne LIVE-Bedarf (Total MA needed)
      let totalNeedLive = 0;
      
      data.forEach(p => {
        totalNeedFix += p.fixNeed;
        totalNeedLive += p.liveNeed;
      });
      
      const setTxt = (id,val)=>{ 
        const n=document.getElementById(id); 
        if(n) n.textContent = String(Math.round(val)); 
      };
      
      // FIX Block
      setTxt('poolFixSum', sumFix);
      setTxt('poolPlanFixSum', totalNeedFix);
      setTxt('poolPlanFixFrSum', frueh);  // Fr√ºhdienst MA (06:00-15:30)
      setTxt('poolPlanFixSpSum', spaet);  // Sp√§tdienst MA (15:30-19:00)
      setTxt('poolPlanFixRotSum', rot);   // Rotation MA (Flexibel)
      
      // LIVE Block
      setTxt('poolLiveSum', sumLive);
      setTxt('poolPlanLiveSum', totalNeedLive);
      setTxt('poolPlanLiveFrSum', frueh);  // Fr√ºhdienst MA (06:00-15:30)
      setTxt('poolPlanLiveSpSum', spaet);  // Sp√§tdienst MA (15:30-19:00)
      setTxt('poolPlanLiveRotSum', rot);   // Rotation MA (Flexibel)
    }catch(e){ 
      console.warn('Pool totals update failed', e); 
    }
  }

  // ROTATION per Klick hinzuf√ºgen/entfernen
  function toggleRotation(poolName) {
    const pool = pools.find(p => p.name === poolName);
    if (pool) {
      pool.useRotation = !pool.useRotation;
      savePools(); // Speichere in localStorage + Server
      rebuildPools(); // Neu rendern
    }
  }

  // Event Listeners f√ºr Pool-System
  if(el_pool('#rate')) el_pool('#rate').addEventListener('input', rebuildPools);
  if(el_pool('#frueh')) el_pool('#frueh').addEventListener('input', rebuildPools);
  if(el_pool('#spaet')) el_pool('#spaet').addEventListener('input', rebuildPools);
  if(el_pool('#rot')) el_pool('#rot').addEventListener('input', rebuildPools);
  if(el_pool('#rotMorning')) el_pool('#rotMorning').addEventListener('change', rebuildPools);
  if(el_pool('#rotMidday')) el_pool('#rotMidday').addEventListener('change', rebuildPools);
  if(el_pool('#rotLate')) el_pool('#rotLate').addEventListener('change', rebuildPools);
  
  document.querySelectorAll('input[name="basis"]').forEach(r=>{
    r.addEventListener('change', rebuildPools);
  });

  // Initial render when page loads - IMMER aus PostgreSQL laden!
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async ()=> {
      // Lade Pools aus PostgreSQL Datenbank
      pools = await loadPoolsFromJSON();
      setTimeout(rebuildPools, 100);
    });
  } else {
    // Seite schon geladen - Lade aus PostgreSQL
    loadPoolsFromJSON().then(loadedPools => {
      pools = loadedPools;
      setTimeout(rebuildPools, 100);
    });
  }
  
  // DIREKT von Google Sheets laden - URL ist fest eingebaut!
  // Live-Vol Daten (altes Sheet - bleibt so wie es war)
  const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1EhhG5Da2kDpLMktcrSdn1DTMnr_XLEdJyNUI2ZwLuQ4/edit?usp=sharing';
  
  // Auto-Refresh AUTOMATISCH starten beim Laden der Seite!
  setTimeout(() => {
    const urlField = document.getElementById('poolSheetsUrl');
    
    // URL automatisch eintragen
    if (urlField) {
      urlField.value = GOOGLE_SHEETS_URL;
      localStorage.setItem('poolSheetsUrl', GOOGLE_SHEETS_URL);
    }
    
    // SOFORT ersten Import machen
    importPoolDataSilent().then(() => {
      // Danach Auto-Refresh starten (alle 1 Sekunde)
      startAutoRefresh();
      console.log('üî¥ LIVE-Modus aktiviert - Live-Vol wird jede Sekunde von Google Sheets geladen!');
      
      // Mitarbeiter Auto-Refresh starten (alle 2 Sekunden)
      startMitarbeiterAutoRefresh();
      
      // Pool-Konfiguration: KEIN Auto-Refresh! √Ñnderungen werden aus Web ins Google Sheet geschrieben
      console.log('‚úÖ Pool-Konfiguration: Web ‚Üí Google Sheet Modus aktiviert');
    }).catch(err => {
      console.error('‚ùå Erster Import fehlgeschlagen:', err);
    });
  }, 500);
  
  // Auto-Refresh starten
  function startAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
    
    autoRefreshEnabled = true;
    updateAutoRefreshStatus();
    
    autoRefreshInterval = setInterval(() => {
      if (autoRefreshEnabled) {
        importPoolDataSilent();
      }
    }, AUTO_REFRESH_SECONDS * 1000);
  }
  
  // Auto-Refresh stoppen
  function stopAutoRefresh() {
    autoRefreshEnabled = false;
    updateAutoRefreshStatus();
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }
  
  // Auto-Refresh umschalten
  function toggleAutoRefresh() {
    if (autoRefreshEnabled) {
      stopAutoRefresh();
    } else {
      startAutoRefresh();
    }
  }
  
  // Status-Anzeige aktualisieren
  function updateAutoRefreshStatus() {
    const statusEl = document.getElementById('autoRefreshStatus');
    const toggleBtn = document.querySelector('button[onclick="toggleAutoRefresh()"]');
    
    if (statusEl) {
      if (autoRefreshEnabled) {
        statusEl.innerHTML = `<span style="color: #29c46d; font-weight: 600;">üî¥ LIVE - Aktualisierung jede Sekunde!</span>`;
      } else {
        statusEl.innerHTML = `<span style="color: #ef476f;">‚óã LIVE pausiert</span>`;
      }
    }
    
    if (toggleBtn) {
      if (autoRefreshEnabled) {
        toggleBtn.innerHTML = '‚è∏Ô∏è Pause';
        toggleBtn.style.background = '#6c757d';
      } else {
        toggleBtn.innerHTML = '‚ñ∂Ô∏è Start';
        toggleBtn.style.background = '#29c46d';
      }
    }
  }
  
  // Save Pool Sheets URL
  function savePoolSheetsUrl() {
    const urlField = document.getElementById('poolSheetsUrl');
    if (urlField?.value?.trim()) {
      localStorage.setItem('poolSheetsUrl', urlField.value.trim());
    }
  }

  // Pool-Daten Import aus Google Sheets (mit Meldungen)
  async function importPoolData() {
    const result = await doImportPoolData(true);
    return result;
  }
  
  // Pool-Daten Import aus Google Sheets (still, ohne Meldungen)
  async function importPoolDataSilent() {
    const result = await doImportPoolData(false);
    return result;
  }
  
  // Haupt-Import Logik - DIREKT von Google Sheets!
  async function doImportPoolData(showMessages) {
    console.log(`üöÄ doImportPoolData gestartet (showMessages=${showMessages})`);
    
    // Verwende die hardcodierte Google Sheets URL
    const sheetsUrl = GOOGLE_SHEETS_URL;
    console.log(`üìã Sheets URL: ${sheetsUrl}`);

    // üî• CACHE-BUSTER: F√ºge Zeitstempel hinzu, damit Google Sheets IMMER frische Daten liefert!
    const timestamp = new Date().getTime();
    
    let csvUrl = sheetsUrl;
    if (sheetsUrl.includes('/edit')) {
      csvUrl = sheetsUrl.replace(/\/edit.*/, `/export?format=csv&t=${timestamp}`);
    } else if (!sheetsUrl.includes('/export')) {
      csvUrl = sheetsUrl + `/export?format=csv&t=${timestamp}`;
    } else {
      csvUrl = csvUrl + `&t=${timestamp}`;
    }

    let loadingOverlay = null;
    if (showMessages) {
      loadingOverlay = document.createElement('div');
      loadingOverlay.className = 'modal-overlay';
      loadingOverlay.innerHTML = `
        <div class="modal-box" style="max-width: 400px;">
          <div class="modal-header">
            <div class="modal-icon info">‚è≥</div>
            <div class="modal-title">Pool-Daten werden geladen...</div>
          </div>
          <div class="modal-content" style="text-align: center; padding: 30px;">
            <p style="color: #6c757d;">Bitte warten...</p>
          </div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
    }

    try {
      // IMMER CORS Proxy verwenden - funktioniert √ºberall!
      const finalUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
      
      const response = await fetch(finalUrl);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const text = await response.text();
      
      if (!text || text.length === 0) {
        throw new Error('Keine Daten empfangen!');
      }
      
      // CSV parsen - Komma ODER Semikolon
      const lines = text.split('\n');
      const rows = lines.map(line => {
        const delimiter = line.includes(';') ? ';' : ',';
        return line.split(delimiter).map(cell => cell.trim());
      });
      
      let imported = 0;
      
      console.log(`üìä CSV Parse: ${rows.length} Zeilen geladen`);
      
      // DIREKT in die Pool-Tabelle schreiben!
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length < 2 || !row[0]) continue;
        
        const poolName = row[0]?.trim();
        const liveVolStr = row[1]?.trim();
        
        if (!poolName || !liveVolStr) continue;
        
        const liveVol = parseInt(liveVolStr.replace(/[^\d-]/g, ''), 10);
        if (isNaN(liveVol)) {
          console.warn(`‚ö†Ô∏è Ung√ºltiger Wert f√ºr "${poolName}": "${liveVolStr}"`);
          continue;
        }
        
        // DIREKT den Pool-Wert aktualisieren - KEIN Umweg!
        const pool = pools.find(p => p.name === poolName);
        if (pool) {
          console.log(`‚úì ${poolName}: ${liveVol}`);
          pool.liveVol = liveVol;
          imported++;
        } else {
          console.warn(`‚ö†Ô∏è Pool nicht gefunden: "${poolName}" (aus Google Sheets)`);
        }
      }
      
      console.log(`üì• Import abgeschlossen: ${imported} Pools aktualisiert`);
      
      if (loadingOverlay) loadingOverlay.remove();
      
      if (imported > 0) {
        rebuildPools();
        
        // Zeitstempel aktualisieren
        const now = new Date();
        const timeStr = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        const updateEl = document.getElementById('poolLastUpdate');
        if (updateEl) {
          updateEl.textContent = `‚úì Letzte Aktualisierung: ${timeStr} Uhr`;
        }
        
        if (showMessages) {
          await customAlert(
            `‚úÖ ${imported} Pool-Live-Vol Werte erfolgreich importiert!`, 
            'Import erfolgreich', 
            'success'
          );
        }
        return true;
      } else {
        if (showMessages) {
          await customAlert(
            'Keine passenden Pool-Daten gefunden.\n\nFormat: Pool-Name (Spalte A), Live-Vol Zahl (Spalte B)', 
            'Warnung', 
            'warning'
          );
        }
        return false;
      }
      
    } catch (error) {
      if (loadingOverlay) loadingOverlay.remove();
      console.error('Fehler beim Laden der Pool-Daten:', error);
      if (showMessages) {
        await customAlert('Fehler beim Laden der Google Sheets Daten. Bitte √ºberpr√ºfen Sie die URL und ob das Sheet √∂ffentlich geteilt ist.', 'Fehler', 'error');
      }
      return false;
    }
  }
  
  // ========== MITARBEITER AUTO-IMPORT SYSTEM ==========
  
  let mitarbeiterData = { maFrueh: 0, maSpat: 0, maRotation: 0 };
  let mitarbeiterAutoRefreshInterval = null;
  
  // Mitarbeiter-Daten aus PostgreSQL laden
  async function loadMitarbeiterFromDB() {
    const datum = getLocalDateString(new Date());
    
    try {
      const response = await fetch(`/api/mitarbeiter/${datum}`);
      if (response.ok) {
        mitarbeiterData = await response.json();
        updateMitarbeiterDisplay();
      }
    } catch (error) {
      console.error('Fehler beim Laden Mitarbeiter aus DB:', error);
    }
  }
  
  // Mitarbeiter-Zahlen anzeigen aktualisieren
  function updateMitarbeiterDisplay() {
    const maFruehEl = document.getElementById('maFrueh');
    const maSpatEl = document.getElementById('maSpat');
    const maRotEl = document.getElementById('maRotation');
    
    if (maFruehEl) maFruehEl.value = mitarbeiterData.maFrueh || 0;
    if (maSpatEl) maSpatEl.value = mitarbeiterData.maSpat || 0;
    if (maRotEl) maRotEl.value = mitarbeiterData.maRotation || 0;
    
    // Trigger Neuberechnung
    if (typeof berechnen === 'function') {
      berechnen();
    }
  }
  
  // Mitarbeiter-Daten in PostgreSQL speichern
  async function saveMitarbeiterToDB(datum, maFrueh, maSpat, maRotation) {
    try {
      await fetch('/api/mitarbeiter/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ datum, maFrueh, maSpat, maRotation })
      });
      console.log('üíæ MA gespeichert:', datum, 'FR√úH:', maFrueh, 'SP√ÑT:', maSpat, 'ROT:', maRotation);
    } catch (error) {
      console.error('Fehler beim Speichern Mitarbeiter:', error);
    }
  }
  
  // Mitarbeiter-Daten aus Google Sheets importieren (AUTOMATISCH!)
  async function doImportMitarbeiterData() {
    const datum = getLocalDateString(new Date());
    
    // Mitarbeiter-Google-Sheet URL (fest kodiert)
    const MITARBEITER_SHEET_ID = '15yfflPhE6Lqykm8aqacnZcrJj0x0Y1Yd';
    const excelUrl = `https://docs.google.com/spreadsheets/d/${MITARBEITER_SHEET_ID}/edit`;
    
    if (!excelUrl) {
      console.log('‚ÑπÔ∏è Keine Mitarbeiter-Sheets URL konfiguriert');
      return false;
    }
    
    const match = excelUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if (!match) {
      console.log('‚ÑπÔ∏è Keine Google Sheets URL f√ºr Mitarbeiter');
      return false;
    }
    
    const spreadsheetId = match[1];
    const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&cachebuster=${Date.now()}`;
    
    try {
      const response = await fetch(csvUrl);
      if (!response.ok) return false;
      
      const text = await response.text();
      const firstLine = text.split('\n')[0] || '';
      const separator = firstLine.includes(';') ? ';' : ',';
      
      const lines = text.split('\n').map(line => {
        const parts = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === separator && !inQuotes) {
            parts.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        parts.push(current);
        return parts;
      });
      
      // Finde die Datumsspalte f√ºr das ausgew√§hlte Datum
      const dateRow = lines[3] || [];
      let targetCol = -1;
      
      const dateParts = datum.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (!dateParts) return false;
      
      const tag = parseInt(dateParts[3], 10);
      const monat = parseInt(dateParts[2], 10);
      const searchDate = `${String(tag).padStart(2, '0')}.${String(monat).padStart(2, '0')}.`;
      
      for (let col = 1; col < dateRow.length; col++) {
        const cellDatum = dateRow[col]?.trim();
        if (cellDatum && cellDatum.startsWith(searchDate)) {
          targetCol = col;
          break;
        }
      }
      
      if (targetCol === -1) {
        console.log('‚ÑπÔ∏è Datum nicht in Mitarbeiter-Sheet gefunden:', searchDate);
        return false;
      }
      
      // Z√§hle FR√úH, SP√ÑT, ROTATION
      let countFrueh = 0;
      let countSpat = 0;
      let countRotation = 0;
      
      for (let row = 5; row < lines.length; row++) {
        const zeile = lines[row];
        const mitarbeiter = zeile[0]?.toString().trim();
        
        if (!mitarbeiter || mitarbeiter.length === 0) continue;
        
        let schichtCode = zeile[targetCol]?.toString().trim().toUpperCase() || '';
        
        if (!schichtCode || schichtCode === '-' || schichtCode === '') continue;
        
        schichtCode = schichtCode.replace(/^\d+\s*/, '');
        
        if (schichtCode === 'FT' || schichtCode === 'A' || schichtCode === 'U' || 
            schichtCode === 'K' || schichtCode === 'URD' || schichtCode === 'KA') continue;
        
        if (schichtCode === 'FR√úH' || schichtCode === 'FRUEH' || 
            schichtCode.startsWith('FR√úH') || schichtCode.startsWith('FRUEH')) {
          countFrueh++;
        } else if (schichtCode === 'SP√ÑT' || schichtCode === 'SPAT' || 
                   schichtCode.startsWith('SP√ÑT') || schichtCode.startsWith('SPAT')) {
          countSpat++;
        } else if (schichtCode === 'ROTATION' || schichtCode.startsWith('ROTATION') || 
                   schichtCode === 'ROT') {
          countRotation++;
        }
      }
      
      // Speichere in PostgreSQL UND aktualisiere Anzeige
      mitarbeiterData = { maFrueh: countFrueh, maSpat: countSpat, maRotation: countRotation };
      await saveMitarbeiterToDB(datum, countFrueh, countSpat, countRotation);
      updateMitarbeiterDisplay();
      
      console.log('‚úÖ MA-Import:', datum, '| FR√úH:', countFrueh, 'SP√ÑT:', countSpat, 'ROT:', countRotation);
      return true;
      
    } catch (error) {
      console.error('Fehler beim MA-Import:', error);
      return false;
    }
  }
  
  // Auto-Refresh f√ºr Mitarbeiter-Daten starten (alle 2 Sekunden)
  function startMitarbeiterAutoRefresh() {
    if (mitarbeiterAutoRefreshInterval) {
      clearInterval(mitarbeiterAutoRefreshInterval);
    }
    
    // Sofort laden
    doImportMitarbeiterData();
    
    // Dann alle 2 Sekunden
    mitarbeiterAutoRefreshInterval = setInterval(() => {
      doImportMitarbeiterData();
    }, 2000);
    
    console.log('üîÑ Mitarbeiter Auto-Refresh gestartet (alle 2 Sek)');
  }
  
  // ========== END MITARBEITER AUTO-IMPORT SYSTEM ==========
  
  // ========== POOL-KONFIGURATION GOOGLE SHEETS SCHREIBEN ==========
  
  // Pool-Konfiguration ins Google Sheet schreiben
  async function savePoolsToGoogleSheets() {
    try {
      console.log('üíæ Speichere Pool-Konfiguration ins Google Sheet...');
      
      // Sende Pools an Backend, das sie ins Google Sheet schreibt
      const response = await fetch('/api/pools/save-to-sheets', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(pools)
      });
      
      if (response.ok) {
        console.log('‚úÖ Pool-Konfiguration ins Google Sheet gespeichert!');
        return true;
      } else {
        console.error('‚ùå Fehler beim Speichern ins Google Sheet:', await response.text());
        return false;
      }
    } catch (error) {
      console.error('‚ùå Fehler beim Speichern ins Google Sheet:', error);
      return false;
    }
  }
  
  // ========== END POOL-KONFIGURATION GOOGLE SHEETS SCHREIBEN ==========
  
</script>

</body>
</html>
